<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comprehensive SEO analysis report for {{ domain }}, including technical issues, content quality, security metrics, and AI-powered recommendations.">
    <meta name="robots" content="noindex, nofollow">
    <meta name="generator" content="SEO Analyzer">
    <title>SEO Analysis Report - {{ domain }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script>
        // Immediate check for Chart.js
        console.log('[INIT] Script loaded, Chart.js status:', typeof Chart);

        // Check if Chart.js loaded
        if (typeof Chart === 'undefined') {
            console.error('[ERROR] Chart.js failed to load from CDN');
            document.addEventListener('DOMContentLoaded', function() {
                console.log('[FALLBACK] Showing error messages for charts');
                const charts = document.querySelectorAll('canvas');
                console.log('[FALLBACK] Found', charts.length, 'canvas elements');
                charts.forEach(canvas => {
                    const parent = canvas.parentElement;
                    const msg = document.createElement('p');
                    msg.style.cssText = 'color: #e53e3e; padding: 20px; text-align: center; border: 1px solid #feb2b2; background: #fff5f5;';
                    msg.textContent = 'Chart failed to load. Please check your internet connection or disable ad blockers.';
                    parent.replaceChild(msg, canvas);
                });
            });
        } else {
            console.log('[SUCCESS] Chart.js loaded, version:', Chart.version);
        }
    </script>
    <style>
        /* NE Brand Colors */
        :root {
            --ne-gold: #967847;
            --ne-gold-light: rgba(150, 120, 71, 0.15);
            --ne-gold-hover: rgba(150, 120, 71, 0.25);
            --ne-dark: #2c3e50;
            --ne-text: #333333;
            --ne-text-secondary: #7f8c8d;
            --ne-bg: #ffffff;
            --ne-bg-alt: #f8f9fa;
            --ne-header-bg: #1a1a1a;
            --ne-border-light: #e0e0e0;
            --ne-success: #27ae60;
            --ne-warning: #f39c12;
            --ne-error: #e74c3c;
            --ne-info: #3498db;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: var(--ne-text);
            background: var(--ne-bg-alt);
        }

        /* NE Logo */
        .ne-logo-link {
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        .ne-logo path {
            fill: #967847;
            transition: fill 0.2s ease;
        }
        .ne-logo-link:hover .ne-logo path {
            fill: #ffffff;
        }

        /* Header - NE Branded */
        header {
            background: var(--ne-header-bg);
            color: #ffffff;
            padding: 40px 0;
            border-bottom: 3px solid var(--ne-gold);
        }

        header .container-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 16px;
            color: #cbd5e0;
            font-weight: 400;
        }

        /* Tab Navigation */
        .tab-container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border: 1px solid var(--ne-border-light);
            margin-top: 20px;
        }

        .tab-nav {
            display: flex;
            background: #edf2f7;
            border-bottom: 2px solid var(--ne-gold);
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab-container input[type="radio"] {
            display: none;
        }

        .tab-nav label {
            padding: 13px 16px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            color: var(--ne-text);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab-nav label:hover {
            background: var(--ne-border-light);
            color: var(--ne-dark);
        }

        #tab1:checked ~ .tab-nav label[for="tab1"],
        #tab2:checked ~ .tab-nav label[for="tab2"],
        #tab3:checked ~ .tab-nav label[for="tab3"],
        #tab4:checked ~ .tab-nav label[for="tab4"],
        #tab5:checked ~ .tab-nav label[for="tab5"],
        #tab6:checked ~ .tab-nav label[for="tab6"],
        #tab7:checked ~ .tab-nav label[for="tab7"],
        #tab8:checked ~ .tab-nav label[for="tab8"],
        #tab9:checked ~ .tab-nav label[for="tab9"],
        #tab10:checked ~ .tab-nav label[for="tab10"] {
            color: var(--ne-dark);
            background: #ffffff;
            border-bottom-color: var(--ne-gold);
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        #tab1:checked ~ .tab-contents #content1,
        #tab2:checked ~ .tab-contents #content2,
        #tab3:checked ~ .tab-contents #content3,
        #tab4:checked ~ .tab-contents #content4,
        #tab5:checked ~ .tab-contents #content5,
        #tab6:checked ~ .tab-contents #content6,
        #tab7:checked ~ .tab-contents #content7,
        #tab8:checked ~ .tab-contents #content8,
        #tab9:checked ~ .tab-contents #content9,
        #tab10:checked ~ .tab-contents #content10 {
            display: block;
        }

        /* Sort arrows */
        .sort-arrow {
            font-size: 10px;
            opacity: 0.4;
            margin-left: 4px;
        }

        /* Legend */
        .perf-legend {
            font-size: 12px;
            color: var(--ne-text-secondary);
            margin-bottom: 16px;
            padding: 12px;
            background: var(--ne-bg-alt);
            border-radius: 0;
        }
        .perf-legend span {
            margin-right: 16px;
        }
        .perf-legend strong {
            color: var(--ne-text);
        }

        /* Executive Summary */
        .summary-intro {
            font-size: 16px;
            color: var(--ne-text);
            margin-bottom: 24px;
            line-height: 1.8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--ne-bg-alt);
            border: 1px solid var(--ne-border-light);
            padding: 20px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 600;
            color: var(--ne-dark);
        }

        .stat-label {
            font-size: 14px;
            color: var(--ne-text-secondary);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Section Headers */
        h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--ne-dark);
            margin: 32px 0 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--ne-gold);
        }

        h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--ne-text);
            margin: 24px 0 12px;
        }

        /* Issue Pattern Sections */
        .issue-pattern {
            margin-bottom: 32px;
            border: 1px solid var(--ne-border-light);
            background: #ffffff;
        }

        .pattern-header {
            background: #edf2f7;
            padding: 16px 20px;
            border-bottom: 1px solid var(--ne-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pattern-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--ne-text);
        }

        .pattern-count {
            background: #c53030;
            color: #ffffff;
            padding: 4px 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .pattern-count.warning {
            background: #ed8936;
        }

        .pattern-count.info {
            background: var(--ne-gold);
        }

        .pattern-body {
            padding: 20px;
        }

        .pattern-description {
            color: var(--ne-text);
            margin-bottom: 16px;
            line-height: 1.7;
        }

        /* Priority Badges */
        .priority {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            color: #ffffff;
            margin-right: 8px;
        }

        .priority-critical {
            background: #c53030;
        }

        .priority-high {
            background: #e53e3e;
        }

        .priority-medium {
            background: #ed8936;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: #ffffff;
        }

        thead {
            background: var(--ne-dark);
            color: #ffffff;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid var(--ne-gold);
        }

        td {
            padding: 12px;
            border: 1px solid var(--ne-border-light);
            font-size: 14px;
        }

        tbody tr:nth-child(even) {
            background: var(--ne-bg-alt);
        }

        tbody tr:hover {
            background: #edf2f7;
        }

        .url-cell {
            font-family: 'Courier New', monospace;
            font-size: 15px;
            color: #000000;
            word-break: break-all;
        }
        .text-red { color: #c53030; }
        .text-orange { color: #dd6b20; }
        .text-green { color: #22543d; }

        /* Remediation Box */
        .remediation {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-left: 4px solid #2f855a;
            padding: 16px;
            margin-top: 16px;
        }

        .remediation-title {
            font-weight: 600;
            color: #22543d;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .remediation-steps {
            list-style: none;
            padding-left: 0;
        }

        .remediation-steps li {
            padding: 6px 0 6px 24px;
            position: relative;
            color: var(--ne-text);
            font-size: 14px;
        }

        .remediation-steps li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #2f855a;
            font-weight: bold;
        }

        /* Analysis Cards */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .analysis-card {
            background: #ffffff;
            border: 1px solid var(--ne-border-light);
            padding: 20px;
        }

        .analysis-card h3 {
            margin-top: 0;
            color: var(--ne-dark);
            font-size: 16px;
            margin-bottom: 16px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--ne-border-light);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--ne-text-secondary);
            font-size: 14px;
        }

        .metric-value {
            font-weight: 600;
            color: var(--ne-text);
            font-size: 14px;
        }

        .score-display {
            font-size: 48px;
            font-weight: 700;
            color: var(--ne-dark);
            text-align: center;
            margin: 20px 0;
        }

        .score-label {
            text-align: center;
            color: var(--ne-text-secondary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Issue List */
        .issue-list {
            list-style: none;
            padding: 0;
        }

        .issue-list li {
            padding: 8px 0 8px 24px;
            position: relative;
            color: #c53030;
            font-size: 14px;
        }

        .issue-list li:before {
            content: "‚ö†";
            position: absolute;
            left: 0;
        }

        /* Success List */
        .success-list {
            list-style: none;
            padding: 0;
        }

        .success-list li {
            padding: 8px 0 8px 24px;
            position: relative;
            color: #2f855a;
            font-size: 14px;
        }

        .success-list li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        /* AI Recommendations */
        .recommendations-text {
            background: var(--ne-bg-alt);
            border: 1px solid var(--ne-border-light);
            padding: 24px;
            line-height: 1.8;
            font-size: 14px;
        }

        .recommendations-text h1 {
            font-size: 28px;
            color: var(--ne-dark);
            margin-top: 32px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--ne-gold);
            padding-bottom: 8px;
        }

        .recommendations-text h2 {
            font-size: 22px;
            color: var(--ne-dark);
            margin-top: 28px;
            margin-bottom: 14px;
            border-bottom: 1px solid #cbd5e0;
            padding-bottom: 6px;
        }

        .recommendations-text h3 {
            font-size: 18px;
            color: var(--ne-text);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .recommendations-text ul, .recommendations-text ol {
            margin-left: 24px;
            margin-bottom: 16px;
        }

        .recommendations-text li {
            margin-bottom: 8px;
            color: var(--ne-text);
        }

        .recommendations-text p {
            margin-bottom: 12px;
            color: var(--ne-text);
        }

        .recommendations-text strong {
            color: var(--ne-dark);
            font-weight: 600;
        }

        .recommendations-text code {
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 0;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            color: #000000;
        }

        .recommendations-text hr {
            border: none;
            border-top: 1px solid #cbd5e0;
            margin: 24px 0;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            color: var(--ne-text-secondary);
            font-size: 14px;
            background: #edf2f7;
            border-top: 1px solid var(--ne-border-light);
            margin-top: 40px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            .tab-nav {
                display: none;
            }
            .tab-content {
                display: block !important;
                page-break-after: always;
            }
            .issue-pattern {
                page-break-inside: avoid;
            }
        }

        /* PSI Modal */
        .psi-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            overflow-y: auto;
            padding: 40px 20px;
        }
        .psi-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .psi-modal {
            background: #fff;
            border-radius: 0;
            max-width: 900px;
            width: 100%;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .psi-modal-header {
            background: linear-gradient(135deg, var(--ne-dark) 0%, var(--ne-gold) 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 0 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .psi-modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 4px 0;
            border: none;
            color: white;
        }
        .psi-modal-header .psi-url {
            font-size: 13px;
            opacity: 0.9;
            word-break: break-all;
        }
        .psi-modal-header .psi-url a {
            color: white;
        }
        .psi-modal-header .psi-meta {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 8px;
        }
        .psi-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
        }
        .psi-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }
        .psi-modal-body {
            padding: 24px;
        }
        .psi-scores-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        @media (max-width: 600px) {
            .psi-scores-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .psi-score-card {
            background: var(--ne-bg-alt);
            border-radius: 0;
            padding: 16px;
            text-align: center;
        }
        .psi-score-card h4 {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            margin: 0 0 8px 0;
        }
        .psi-score-value {
            font-size: 36px;
            font-weight: 700;
        }
        .psi-score-value.good { color: #0cce6b; }
        .psi-score-value.needs-improvement { color: #ffa400; }
        .psi-score-value.poor { color: #ff4e42; }
        .psi-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        @media (max-width: 600px) {
            .psi-metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .psi-metric {
            padding: 12px;
            background: #f9fafb;
            border-radius: 0;
            text-align: center;
        }
        .psi-metric .label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .psi-metric .value {
            font-size: 18px;
            font-weight: 600;
        }
        .psi-section {
            margin-bottom: 20px;
        }
        .psi-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            text-transform: uppercase;
            color: #666;
        }
        .psi-opportunity {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .psi-opportunity:last-child {
            border-bottom: none;
        }
        .psi-opp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .psi-opp-title {
            font-weight: 500;
            font-size: 14px;
        }
        .psi-opp-savings {
            font-size: 13px;
            color: #ff4e42;
            font-weight: 500;
        }
        .psi-opp-desc {
            font-size: 12px;
            color: #666;
        }
        .psi-fresh-link {
            display: inline-block;
            margin-top: 16px;
            color: var(--ne-gold);
            text-decoration: none;
            font-size: 14px;
        }
        .psi-fresh-link:hover {
            text-decoration: underline;
        }
        .psi-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 0;
            font-size: 11px;
            font-weight: 600;
        }
        .psi-badge.good { background: #d4edda; color: #155724; }
        .psi-badge.needs-improvement { background: #fff3cd; color: #856404; }
        .psi-badge.poor { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <header>
        <div class="container-inner" style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- NE Logo - Gold default, white on hover -->
                <a href="https://newelevation.com" target="_blank" class="ne-logo-link" title="New Elevation">
                    <svg class="ne-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 289.96 87.88" width="120" height="36" role="img" aria-labelledby="neLogoTitle">
                        <title id="neLogoTitle">New Elevation</title>
                        <path d="M115.51 11.21v15.85h-.11l-12.35-12.18h-.09v11.91h-1.02V10.94h.11l12.35 12.18h.09V11.21h1.02Zm23.19 0v1.22h-8.04v5.59h6.9v1.02h-6.9v6.52h8.04v1.22h-10.06V11.2h10.06Zm11.18 0 4.59 12.93h.09l4.43-12.93h.96l4.34 13h.09l4.61-13h1.02l-5.52 15.58h-1.31l-4.12-12.18h-.11l-4.25 12.18h-1.34l-5.52-15.58h2.05Zm-37.89 26.72v1.22h-8.04v5.59h6.9v1.02h-6.9v6.52h8.04v1.22h-10.06V37.92h10.06Zm11.13 15.58V37.93h2.03v14.36h8.04v1.22h-10.06Zm31.26-15.58v1.22h-8.04v5.59h6.9v1.02h-6.9v6.52h8.04v1.22h-10.06V37.92h10.06Zm11.53 0 5.34 12.82h.09l5.19-12.82h1.16l-6.32 15.58h-1.34l-6.52-15.58h2.4Zm21.88 10.99-1.96 4.59h-1.02l6.59-15.58h1.11l7.26 15.58h-2.16l-2.14-4.59h-7.68Zm3.72-8.5h-.09l-3.21 7.5H195l-3.5-7.5Zm20.45 13.09V39.15h-5.97v-1.22h13.96v1.22h-5.96v14.36h-2.03Zm21.82-15.58v15.58h-2.03V37.93h2.03Zm12.94 5.09c.32-.95.82-1.82 1.5-2.62.68-.79 1.55-1.45 2.6-1.97s2.32-.78 3.79-.78 2.77.26 3.86.79c1.09.53 1.99 1.19 2.71 1.99.71.8 1.24 1.67 1.58 2.62.34.94.51 1.83.51 2.66 0 .55-.08 1.13-.23 1.74s-.39 1.21-.69 1.81c-.3.6-.7 1.17-1.17 1.71s-1.04 1.02-1.68 1.44c-.65.42-1.37.75-2.18.99s-1.71.37-2.71.37c-1.47 0-2.73-.26-3.79-.79-1.05-.53-1.92-1.19-2.6-1.99-.68-.8-1.18-1.67-1.5-2.62-.32-.94-.48-1.83-.48-2.66s.16-1.74.48-2.69Zm2.19 5.56c.32.87.76 1.61 1.31 2.24.56.62 1.21 1.11 1.97 1.46.76.35 1.58.52 2.47.52s1.7-.17 2.48-.52 1.46-.83 2.05-1.46c.59-.62 1.05-1.37 1.39-2.24.34-.87.51-1.82.51-2.86s-.17-1.99-.51-2.86c-.34-.87-.81-1.61-1.39-2.24-.59-.62-1.27-1.11-2.05-1.46s-1.61-.52-2.48-.52-1.71.17-2.47.52c-.76.35-1.41.83-1.97 1.46-.56.62-.99 1.37-1.31 2.24-.32.87-.48 1.82-.48 2.86s.16 1.99.48 2.86Zm39.52-10.65v15.85h-.11L275.97 41.6h-.09v11.91h-1.02V37.66h.11l12.35 12.18h.09V37.93h1.02ZM20.89 66.77a693.393 693.393 0 0 0 46.09-46.09 695.798 695.798 0 0 0-46.09 46.09Zm3.34-39.57h.09L35.7 39.33h.11V23.54h-1.02V35.4h-.09L23.32 23.28h-.11v15.78h1.02V27.2zM54.3 64.62h10.25V63.4h-8.23v-6.5h7.1v-1.02h-7.1v-5.57h8.23v-1.22H54.3v15.53z" fill="#967847"/>
                        <path d="M43.94 0C19.67 0 0 19.67 0 43.94c0 24.27 19.67 43.94 43.94 43.94 24.27 0 43.94-19.67 43.94-43.94C87.88 19.67 68.2 0 43.94 0Zm30.03 73.97c-7.69 7.69-18.3 12.44-30.03 12.44S21.6 81.66 13.91 73.97C6.22 66.28 1.47 55.67 1.47 43.94S6.22 21.6 13.91 13.91C21.6 6.22 32.21 1.47 43.94 1.47s22.34 4.75 30.03 12.44c7.69 7.69 12.44 18.3 12.44 30.03s-4.75 22.34-12.44 30.03Z" fill="#967847"/>
                    </svg>
                </a>
                <div>
                    <h1 style="margin: 0; font-size: 24px;">SEO Analysis Report</h1>
                    <p class="subtitle" style="margin: 0;">{{ domain }}</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 14px; color: #999;">
                <div>Analyzed on</div>
                <div style="color: #fff;">{{ crawled_at }}</div>
            </div>
        </div>
    </header>

    <div class="tab-container">
        <input type="radio" name="tabs" id="tab1" checked>
        <input type="radio" name="tabs" id="tab2">
        <input type="radio" name="tabs" id="tab3">
        <input type="radio" name="tabs" id="tab4">
        <input type="radio" name="tabs" id="tab5">
        <input type="radio" name="tabs" id="tab6">
        <input type="radio" name="tabs" id="tab7">
        <input type="radio" name="tabs" id="tab8">
        <input type="radio" name="tabs" id="tab9">
        <input type="radio" name="tabs" id="tab10">

        <div class="tab-nav">
            <label for="tab1">Overview</label>
            <label for="tab10">All Pages</label>
            <label for="tab9">Performance</label>
            <label for="tab2">Issues</label>
            <label for="tab3">Content</label>
            <label for="tab4">Schema</label>
            <label for="tab5">Security</label>
            <label for="tab6">URLs</label>
            <label for="tab7">Recommendations</label>
            <label for="tab8">Trends</label>
        </div>

        <div class="tab-contents">
            <!-- Tab 1: Overview -->
            <div id="content1" class="tab-content">
                <h2>Executive Summary</h2>
                <p class="summary-intro">
                    Comprehensive SEO analysis of {{ total_pages }} pages. This report identifies technical issues,
                    content quality metrics, security concerns, and provides actionable remediation strategies.
                </p>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ total_pages }}</div>
                        <div class="stat-label">Pages Analyzed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ total_issues }}</div>
                        <div class="stat-label">Total Issues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ critical_issues }}</div>
                        <div class="stat-label">Critical Issues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ total_words | format_number }}</div>
                        <div class="stat-label">Total Words</div>
                    </div>
                    {% if advanced_summary %}
                    <div class="stat-card">
                        <div class="stat-value">{{ advanced_summary.avg_readability|default(0)|round(1) }}</div>
                        <div class="stat-label">Avg Readability</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ advanced_summary.avg_security_score|default(0)|round(0) }}%</div>
                        <div class="stat-label">Security Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ advanced_summary.avg_mobile_score|default(0)|round(0) }}%</div>
                        <div class="stat-label">Mobile Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ advanced_summary.https_pages }}/{{ total_pages }}</div>
                        <div class="stat-label">HTTPS Pages</div>
                    </div>
                    {% endif %}
                </div>

                <h2>Key Findings</h2>
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3>Critical Priority</h3>
                        <ul class="issue-list">
                            {% if critical_patterns %}
                            {% for pattern in critical_patterns[:5] %}
                            <li>{{ pattern.title }}: {{ pattern.count }} pages</li>
                            {% endfor %}
                            {% else %}
                            <li style="color: #2f855a;">No critical issues found</li>
                            {% endif %}
                        </ul>
                    </div>

                    <div class="analysis-card">
                        <h3>High Priority</h3>
                        <ul class="issue-list">
                            {% if high_patterns %}
                            {% for pattern in high_patterns[:5] %}
                            <li>{{ pattern.title }}: {{ pattern.count }} pages</li>
                            {% endfor %}
                            {% else %}
                            <li style="color: #2f855a;">No high priority issues found</li>
                            {% endif %}
                        </ul>
                    </div>

                    <div class="analysis-card">
                        <h3>Medium Priority</h3>
                        <ul class="issue-list">
                            {% if medium_patterns %}
                            {% for pattern in medium_patterns[:5] %}
                            <li>{{ pattern.title }}: {{ pattern.count }} pages</li>
                            {% endfor %}
                            {% else %}
                            <li style="color: #2f855a;">No medium priority issues found</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>

                {% if advanced_summary %}
                <h2>SEO Health Overview</h2>
                <div class="analysis-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="analysis-card">
                        <h3>Overall SEO Scores</h3>
                        <canvas id="radarChart" style="max-height: 350px;"></canvas>
                    </div>
                    <div class="analysis-card">
                        <h3>Issue Distribution</h3>
                        <canvas id="issueChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
                {% endif %}

                {% if technology_analysis and technology_analysis.enabled %}
                <h2>üîß Technology Stack</h2>
                <p class="summary-intro">
                    Technologies, platforms, and services powering this website (detected across {{ technology_analysis.total_pages_analyzed }} pages).
                </p>

                <div class="analysis-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    {% if technology_analysis.ecommerce_platforms %}
                    <div class="analysis-card">
                        <h3>üõí Ecommerce Platform</h3>
                        <ul class="success-list">
                            {% for platform in technology_analysis.ecommerce_platforms %}
                            <li>{{ platform }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if technology_analysis.cms_platforms %}
                    <div class="analysis-card">
                        <h3>üìù Content Management</h3>
                        <ul class="success-list">
                            {% for cms in technology_analysis.cms_platforms %}
                            <li>{{ cms }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if technology_analysis.web_servers %}
                    <div class="analysis-card">
                        <h3>üñ•Ô∏è Web Server</h3>
                        <ul class="success-list">
                            {% for server in technology_analysis.web_servers %}
                            <li>{{ server }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if technology_analysis.cdns %}
                    <div class="analysis-card">
                        <h3>üåê Content Delivery</h3>
                        <ul class="success-list">
                            {% for cdn in technology_analysis.cdns %}
                            <li>{{ cdn }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if technology_analysis.analytics_tools %}
                    <div class="analysis-card">
                        <h3>üìä Analytics</h3>
                        <ul class="success-list">
                            {% for tool in technology_analysis.analytics_tools %}
                            <li>{{ tool }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if technology_analysis.js_frameworks %}
                    <div class="analysis-card">
                        <h3>‚öõÔ∏è JavaScript Frameworks</h3>
                        <ul class="success-list">
                            {% for framework in technology_analysis.js_frameworks %}
                            <li>{{ framework }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <h3>All Detected Technologies ({{ technology_analysis.total_technologies }})</h3>
                <div class="analysis-card">
                    {% if technology_analysis.by_category %}
                        {% for category, techs in technology_analysis.by_category.items() %}
                        <div style="margin-bottom: 1rem;">
                            <strong>{{ category }}:</strong>
                            <span style="color: var(--ne-text-secondary);">{{ techs|join(', ') }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                    <p style="color: var(--ne-text-secondary);">No technologies detected</p>
                    {% endif %}
                </div>

                {% if technology_analysis.top_10_technologies %}
                <h3>Technology Coverage</h3>
                <p class="summary-intro">Percentage of pages using each technology</p>
                <table>
                    <thead>
                        <tr>
                            <th>Technology</th>
                            <th>Pages</th>
                            <th>Coverage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tech, count in technology_analysis.top_10_technologies %}
                        {% set coverage = technology_analysis.technology_coverage.get(tech, {}) %}
                        <tr>
                            <td><strong>{{ tech }}</strong></td>
                            <td>{{ count }} / {{ technology_analysis.total_pages_analyzed }}</td>
                            <td>{{ coverage.percentage }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
                {% endif %}

            </div>

            <!-- Tab 2: Technical Issues -->
            <div id="content2" class="tab-content">
                <h2>Technical SEO Issues</h2>
                <p class="summary-intro">
                    Technical issues have the highest impact on SEO performance and should be addressed systematically by priority.
                </p>

                {% if critical_patterns %}
                <h2>Critical Issues</h2>
                {% for pattern in critical_patterns %}
                <div class="issue-pattern">
                    <div class="pattern-header">
                        <div>
                            <span class="priority priority-critical">CRITICAL</span>
                            <span class="pattern-title">{{ pattern.title }}</span>
                        </div>
                        <span class="pattern-count">{{ pattern.count }} affected</span>
                    </div>
                    <div class="pattern-body">
                        <div class="pattern-description">
                            <strong>Issue:</strong> {{ pattern.description }}
                        </div>

                        {% if pattern.examples %}
                        <h4 style="margin: 16px 0 8px; font-size: 14px; font-weight: 600;">Examples:</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50%;">URL</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for example in pattern.examples[:5] %}
                                <tr>
                                    <td class="url-cell">{{ example.url }}</td>
                                    <td>{{ example.detail }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if pattern.count > 5 %}
                        <p style="font-size: 13px; color: var(--ne-text-secondary); margin-top: 8px;">
                            ...and {{ pattern.count - 5 }} more pages with this issue
                        </p>
                        {% endif %}
                        {% endif %}

                        <div class="remediation">
                            <div class="remediation-title">‚úì REMEDIATION STEPS</div>
                            <ul class="remediation-steps">
                                {% for step in pattern.remediation %}
                                <li>{{ step }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}

                {% if high_patterns %}
                <h2>High Priority Issues</h2>
                {% for pattern in high_patterns %}
                <div class="issue-pattern">
                    <div class="pattern-header">
                        <div>
                            <span class="priority priority-high">HIGH</span>
                            <span class="pattern-title">{{ pattern.title }}</span>
                        </div>
                        <span class="pattern-count">{{ pattern.count }} affected</span>
                    </div>
                    <div class="pattern-body">
                        <div class="pattern-description">
                            <strong>Issue:</strong> {{ pattern.description }}
                        </div>

                        {% if pattern.examples %}
                        <h4 style="margin: 16px 0 8px; font-size: 14px; font-weight: 600;">Examples:</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50%;">URL</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for example in pattern.examples[:5] %}
                                <tr>
                                    <td class="url-cell">{{ example.url }}</td>
                                    <td>{{ example.detail }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}

                        <div class="remediation">
                            <div class="remediation-title">‚úì REMEDIATION STEPS</div>
                            <ul class="remediation-steps">
                                {% for step in pattern.remediation %}
                                <li>{{ step }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}

                {% if medium_patterns %}
                <h2>Medium Priority Issues</h2>
                {% for pattern in medium_patterns %}
                <div class="issue-pattern">
                    <div class="pattern-header">
                        <div>
                            <span class="priority priority-medium">MEDIUM</span>
                            <span class="pattern-title">{{ pattern.title }}</span>
                        </div>
                        <span class="pattern-count warning">{{ pattern.count }} affected</span>
                    </div>
                    <div class="pattern-body">
                        <div class="pattern-description">
                            <strong>Issue:</strong> {{ pattern.description }}
                        </div>

                        {% if pattern.examples %}
                        <h4 style="margin: 16px 0 8px; font-size: 14px; font-weight: 600;">Examples:</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50%;">URL</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for example in pattern.examples[:3] %}
                                <tr>
                                    <td class="url-cell">{{ example.url }}</td>
                                    <td>{{ example.detail }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}

                        <div class="remediation">
                            <div class="remediation-title">‚úì REMEDIATION STEPS</div>
                            <ul class="remediation-steps">
                                {% for step in pattern.remediation %}
                                <li>{{ step }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>

            <!-- Tab 3: Content Quality -->
            <div id="content3" class="tab-content">
                <h2>Content Quality Analysis</h2>
                <p class="summary-intro">
                    Content quality metrics including readability scores, keyword density, and content depth analysis.
                </p>

                {% if content_quality %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3>Average Readability</h3>
                        <div class="score-display">{{ content_quality.avg_readability|round(1) }}</div>
                        <div class="score-label">Flesch Reading Ease</div>
                        <p style="margin-top: 16px; color: var(--ne-text-secondary); font-size: 14px; text-align: center;">
                            {{ content_quality.avg_grade }}
                        </p>
                    </div>

                    <div class="analysis-card">
                        <h3>Content Metrics</h3>
                        <div class="metric-row">
                            <span class="metric-label">Pages Analyzed</span>
                            <span class="metric-value">{{ content_quality.pages_analyzed }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Avg Words/Page</span>
                            <span class="metric-value">{{ content_quality.avg_word_count|round(0) }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Avg Sentences/Page</span>
                            <span class="metric-value">{{ content_quality.avg_sentence_count|round(0) }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Avg Unique Words</span>
                            <span class="metric-value">{{ content_quality.avg_unique_words|round(0) }}</span>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h3>Content Issues</h3>
                        {% if content_quality.issues %}
                        <ul class="issue-list">
                            {% for issue in content_quality.issues %}
                            <li>{{ issue }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <ul class="success-list">
                            <li>Content quality is good</li>
                            <li>Readability is appropriate</li>
                            <li>No major content issues detected</li>
                        </ul>
                        {% endif %}
                    </div>
                </div>

                <h2>Top Pages by Quality</h2>
                <table id="qualityTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable('qualityTable', 0, 'quality')">URL <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('qualityTable', 1, 'quality')">Readability <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('qualityTable', 2, 'quality')">Grade Level <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('qualityTable', 3, 'quality')">Word Count <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for page in content_quality.top_pages[:10] %}
                        <tr>
                            <td class="url-cell">{{ page.url }}</td>
                            <td style="text-align: center;">{{ page.readability_score|round(1) }}</td>
                            <td style="text-align: center;">{{ page.readability_grade }}</td>
                            <td style="text-align: center;">{{ page.word_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if content_quality %}
                <h2>Readability Distribution</h2>
                <div class="analysis-card" style="max-width: 800px; margin: 0 auto;">
                    <canvas id="readabilityChart" style="max-height: 300px;"></canvas>
                </div>
                {% endif %}
                {% else %}
                <p style="color: var(--ne-text-secondary);">Content quality analysis not available for this crawl.</p>
                {% endif %}
            </div>

            <!-- Tab 4: Structured Data -->
            <div id="content4" class="tab-content">
                <h2>Structured Data & Rich Results</h2>
                <p class="summary-intro">
                    Structured data helps search engines understand your content and can enable rich results in search.
                </p>

                {% if sd_analysis %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3>Structured Data Score</h3>
                        <div class="score-display" style="{% if sd_analysis.overall_status == 'excellent' %}color: #2f855a;{% elif sd_analysis.overall_status == 'good' %}color: var(--ne-gold);{% elif sd_analysis.overall_status == 'needs-improvement' %}color: #ed8936;{% else %}color: #c53030;{% endif %}">
                            {{ sd_analysis.avg_score|round(0) }}
                        </div>
                        <div class="score-label">{{ sd_analysis.overall_status|upper }}</div>
                        <p style="margin-top: 12px; color: var(--ne-text-secondary); font-size: 14px; text-align: center;">
                            {{ sd_analysis.pages_with_schema_count }}/{{ sd_analysis.total_pages }} pages have schema
                        </p>
                    </div>

                    <div class="analysis-card">
                        <h3>Schema Implementation</h3>
                        <div class="metric-row">
                            <span class="metric-label">JSON-LD Blocks</span>
                            <span class="metric-value">{{ sd_analysis.jsonld_count }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Microdata Items</span>
                            <span class="metric-value">{{ sd_analysis.microdata_count }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Schema Types</span>
                            <span class="metric-value">{{ sd_analysis.schema_types|length }}</span>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h3>Validation Status</h3>
                        <div class="metric-row">
                            <span class="metric-label">Errors</span>
                            <span class="metric-value" style="{% if sd_analysis.total_errors > 0 %}color: #c53030;{% endif %}">{{ sd_analysis.total_errors }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Warnings</span>
                            <span class="metric-value" style="{% if sd_analysis.total_warnings > 0 %}color: #ed8936;{% endif %}">{{ sd_analysis.total_warnings }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Pages Without Schema</span>
                            <span class="metric-value">{{ sd_analysis.pages_without_schema_count }}</span>
                        </div>
                    </div>
                </div>

                {% if sd_analysis.schema_types %}
                <h3>Schema Types Found</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px;">
                    {% for schema_type in sd_analysis.schema_types %}
                    <span style="background: var(--ne-gold); color: white; padding: 6px 12px; border-radius: 0; font-size: 13px; font-weight: 500;">
                        {{ schema_type }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}

                <h3>Rich Result Eligibility</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Rich Result Type</th>
                            <th>Eligible Pages</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result_type, count in sd_analysis.rich_results.items() %}
                        <tr>
                            <td style="text-transform: capitalize;">{{ result_type.replace('_', ' ') }}</td>
                            <td>{{ count }}/{{ sd_analysis.total_pages }}</td>
                            <td style="{% if count > 0 %}color: #2f855a; font-weight: 600;{% else %}color: var(--ne-text-secondary);{% endif %}">
                                {% if count > 0 %}‚úì ELIGIBLE{% else %}Not Eligible{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% if sd_analysis.missing_opportunities %}
                <h3>Missing Opportunities</h3>
                <ul class="issue-list">
                    {% for opportunity in sd_analysis.missing_opportunities %}
                    <li>{{ opportunity }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if sd_analysis.unique_errors %}
                <h3>Validation Errors</h3>
                <ul class="issue-list">
                    {% for error in sd_analysis.unique_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if sd_analysis.unique_warnings %}
                <h3>Validation Warnings</h3>
                <ul class="issue-list" style="color: #ed8936;">
                    {% for warning in sd_analysis.unique_warnings %}
                    <li>{{ warning }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                <div class="remediation" style="margin-top: 24px;">
                    <div class="remediation-title">üéØ STRUCTURED DATA RECOMMENDATIONS</div>
                    <ul class="remediation-steps">
                        <li>Use JSON-LD format (preferred by Google) instead of Microdata or RDFa</li>
                        <li>Add Product schema to e-commerce pages with offers and reviews</li>
                        <li>Implement BreadcrumbList schema for better navigation display</li>
                        <li>Add FAQPage schema to pages with frequently asked questions</li>
                        <li>Use Organization schema on your homepage with logo and social profiles</li>
                        <li>Add Article/BlogPosting schema to blog posts with author and publisher</li>
                        <li>Include Review and AggregateRating schema for user reviews</li>
                        <li>Test your structured data with <a href="https://search.google.com/test/rich-results" target="_blank" style="color: var(--ne-gold);">Google's Rich Results Test</a></li>
                        <li>Validate schema markup with <a href="https://validator.schema.org/" target="_blank" style="color: var(--ne-gold);">Schema.org Validator</a></li>
                    </ul>
                </div>
                {% else %}
                <p style="color: var(--ne-text-secondary);">Structured data analysis not available for this crawl.</p>
                {% endif %}
            </div>

            <!-- Tab 5: Security & Mobile -->
            <div id="content5" class="tab-content">
                <h2>Security Analysis</h2>

                {% if security_analysis %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3>Security Score</h3>
                        <div class="score-display">{{ security_analysis.avg_score|round(0) }}%</div>
                        <div class="score-label">Overall Security</div>
                    </div>

                    <div class="analysis-card">
                        <h3>HTTPS Status</h3>
                        <div class="metric-row">
                            <span class="metric-label">Secure Pages</span>
                            <span class="metric-value">{{ security_analysis.https_count }}/{{ security_analysis.total_pages }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Percentage</span>
                            <span class="metric-value">{{ (security_analysis.https_count / security_analysis.total_pages * 100)|round(1) }}%</span>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h3>Security Headers</h3>
                        {% if security_analysis.complete_headers %}
                        <ul class="success-list">
                            {% for header in security_analysis.complete_headers %}
                            <li>{{ header }} (100%)</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% if security_analysis.partial_headers %}
                        <ul class="issue-list" style="margin-top: 8px;">
                            {% for header, data in security_analysis.partial_headers.items() %}
                            <li style="color: #ed8936;">{{ header }}: {{ data.count }}/{{ security_analysis.total_pages }} pages ({{ data.percentage }}%)</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% if security_analysis.missing_headers %}
                        <ul class="issue-list" style="margin-top: 8px;">
                            {% for header in security_analysis.missing_headers %}
                            <li style="color: #c53030;">Missing: {{ header }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% if not security_analysis.complete_headers and not security_analysis.partial_headers and not security_analysis.missing_headers %}
                        <p style="color: var(--ne-text-secondary);">No security header data available</p>
                        {% endif %}
                    </div>
                </div>

                {% if security_analysis.insecure_pages %}
                <h3>Non-HTTPS Pages</h3>
                <table>
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Issue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for page in security_analysis.insecure_pages %}
                        <tr>
                            <td class="url-cell">{{ page }}</td>
                            <td style="color: #c53030;">Not using HTTPS</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}

                <!-- Security Recommendations -->
                <div class="remediation" style="margin-top: 24px;">
                    <div class="remediation-title">üîí SECURITY RECOMMENDATIONS</div>
                    <ul class="remediation-steps">
                        <li><strong>HSTS (Strict-Transport-Security):</strong> Add header to force HTTPS connections and prevent downgrade attacks</li>
                        <li><strong>X-Content-Type-Options:</strong> Set to "nosniff" to prevent MIME type sniffing attacks</li>
                        <li><strong>X-Frame-Options:</strong> Set to "DENY" or "SAMEORIGIN" to prevent clickjacking</li>
                        <li><strong>Content-Security-Policy:</strong> Define allowed sources for scripts, styles, and other resources</li>
                        <li><strong>Referrer-Policy:</strong> Control how much referrer information is shared with other sites</li>
                        <li><strong>Permissions-Policy:</strong> Control which browser features can be used on your site</li>
                    </ul>
                </div>

                <!-- Security Best Practices -->
                <h3 style="margin-top: 32px;">Security Best Practices Checklist</h3>
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4 style="margin-bottom: 12px;">Transport Security</h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="padding: 6px 0; border-bottom: 1px solid var(--ne-border-light);">
                                {% if security_analysis.https_count == security_analysis.total_pages %}
                                <span style="color: #22543d;">‚úì</span>
                                {% else %}
                                <span style="color: #c53030;">‚úó</span>
                                {% endif %}
                                All pages use HTTPS
                            </li>
                            <li style="padding: 6px 0; border-bottom: 1px solid var(--ne-border-light);">
                                {% if 'strict-transport-security' in security_analysis.complete_headers|default([]) %}
                                <span style="color: #22543d;">‚úì</span>
                                {% else %}
                                <span style="color: #c53030;">‚úó</span>
                                {% endif %}
                                HSTS header enabled
                            </li>
                            <li style="padding: 6px 0;">
                                {% if security_analysis.https_count == security_analysis.total_pages %}
                                <span style="color: #22543d;">‚úì</span>
                                {% else %}
                                <span style="color: #dd6b20;">‚ö†</span>
                                {% endif %}
                                No mixed content issues
                            </li>
                        </ul>
                    </div>
                    <div class="analysis-card">
                        <h4 style="margin-bottom: 12px;">Content Security</h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="padding: 6px 0; border-bottom: 1px solid var(--ne-border-light);">
                                {% if 'content-security-policy' in security_analysis.complete_headers|default([]) %}
                                <span style="color: #22543d;">‚úì</span>
                                {% else %}
                                <span style="color: #c53030;">‚úó</span>
                                {% endif %}
                                Content Security Policy
                            </li>
                            <li style="padding: 6px 0; border-bottom: 1px solid var(--ne-border-light);">
                                {% if 'x-content-type-options' in security_analysis.complete_headers|default([]) %}
                                <span style="color: #22543d;">‚úì</span>
                                {% else %}
                                <span style="color: #c53030;">‚úó</span>
                                {% endif %}
                                X-Content-Type-Options
                            </li>
                            <li style="padding: 6px 0;">
                                {% if 'x-frame-options' in security_analysis.complete_headers|default([]) %}
                                <span style="color: #22543d;">‚úì</span>
                                {% else %}
                                <span style="color: #c53030;">‚úó</span>
                                {% endif %}
                                X-Frame-Options
                            </li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Tab 6: URL & International -->
            <div id="content6" class="tab-content">
                <h2>URL Structure Analysis</h2>

                {% if url_analysis %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3>URL Quality</h3>
                        <div class="metric-row">
                            <span class="metric-label">Pages Analyzed</span>
                            <span class="metric-value">{{ url_analysis.total_pages }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">With Keywords</span>
                            <span class="metric-value">{{ url_analysis.with_keywords }}/{{ url_analysis.total_pages }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Total Issues</span>
                            <span class="metric-value">{{ url_analysis.total_issues }}</span>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h3>Common URL Issues</h3>
                        {% if url_analysis.common_issues %}
                        <ul class="issue-list">
                            {% for issue in url_analysis.common_issues %}
                            <li>{{ issue }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <ul class="success-list">
                            <li>URLs are well-structured</li>
                            <li>No major URL issues found</li>
                        </ul>
                        {% endif %}
                    </div>
                </div>

                {% if url_analysis.problematic_urls %}
                <h3>URLs Needing Attention</h3>
                <table id="urlsTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable('urlsTable', 0, 'urls')">URL <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer;" onclick="sortTable('urlsTable', 1, 'urls')">Issues <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in url_analysis.problematic_urls[:20] %}
                        <tr>
                            <td class="url-cell">{{ item.url }}</td>
                            <td>{{ item.issues|join(', ') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
                {% endif %}

                <h2>International SEO</h2>

                {% if international_analysis %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3>Language Configuration</h3>
                        <div class="metric-row">
                            <span class="metric-label">Pages with Lang</span>
                            <span class="metric-value">{{ international_analysis.lang_count }}/{{ international_analysis.total_pages }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Pages with Hreflang</span>
                            <span class="metric-value">{{ international_analysis.hreflang_count }}/{{ international_analysis.total_pages }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">UTF-8 Charset</span>
                            <span class="metric-value">{{ international_analysis.utf8_count }}/{{ international_analysis.total_pages }}</span>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h3>International Issues</h3>
                        {% if international_analysis.issues %}
                        <ul class="issue-list">
                            {% for issue in international_analysis.issues %}
                            <li>{{ issue }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <ul class="success-list">
                            <li>Language attributes properly set</li>
                            <li>Charset configured correctly</li>
                        </ul>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <h2>Crawlability & Discovery</h2>
                <p class="summary-intro">
                    Analyze how easily search engines can discover and crawl your site.
                </p>

                {% if crawlability_analysis %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3>Crawlability Score</h3>
                        <div class="score-display" style="{% if crawlability_analysis.overall_score >= 80 %}color: #2f855a;{% elif crawlability_analysis.overall_score >= 60 %}color: var(--ne-gold);{% elif crawlability_analysis.overall_score >= 40 %}color: #ed8936;{% else %}color: #c53030;{% endif %}">
                            {{ crawlability_analysis.overall_score }}
                        </div>
                        <div class="score-label">Overall Crawlability</div>
                    </div>

                    <div class="analysis-card">
                        <h3>robots.txt Status</h3>
                        <div class="metric-row">
                            <span class="metric-label">Has robots.txt</span>
                            <span class="metric-value" style="{% if crawlability_analysis.has_robots_txt %}color: #2f855a;{% else %}color: #c53030;{% endif %}">
                                {% if crawlability_analysis.has_robots_txt %}‚úì YES{% else %}‚úó NO{% endif %}
                            </span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Errors</span>
                            <span class="metric-value" style="{% if crawlability_analysis.robots_txt_errors|length > 0 %}color: #c53030;{% endif %}">
                                {{ crawlability_analysis.robots_txt_errors|length }}
                            </span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Warnings</span>
                            <span class="metric-value" style="{% if crawlability_analysis.robots_txt_warnings|length > 0 %}color: #ed8936;{% endif %}">
                                {{ crawlability_analysis.robots_txt_warnings|length }}
                            </span>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h3>XML Sitemap Status</h3>
                        <div class="metric-row">
                            <span class="metric-label">Has Sitemap</span>
                            <span class="metric-value" style="{% if crawlability_analysis.has_xml_sitemap %}color: #2f855a;{% else %}color: #c53030;{% endif %}">
                                {% if crawlability_analysis.has_xml_sitemap %}‚úì YES{% else %}‚úó NO{% endif %}
                            </span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Pages Crawled</span>
                            <span class="metric-value">{{ crawlability_analysis.pages_crawled }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Orphan Pages</span>
                            <span class="metric-value" style="{% if crawlability_analysis.orphan_pages|length > 0 %}color: #ed8936;{% endif %}">
                                {{ crawlability_analysis.orphan_pages|length }}
                            </span>
                        </div>
                    </div>
                </div>

                {% if crawlability_analysis.robots_txt_errors %}
                <h3>robots.txt Errors</h3>
                <ul class="issue-list">
                    {% for error in crawlability_analysis.robots_txt_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if crawlability_analysis.sitemap_errors %}
                <h3>Sitemap Errors</h3>
                <ul class="issue-list">
                    {% for error in crawlability_analysis.sitemap_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if crawlability_analysis.recommendations %}
                <div class="remediation" style="margin-top: 24px;">
                    <div class="remediation-title">üîç CRAWLABILITY RECOMMENDATIONS</div>
                    <ul class="remediation-steps">
                        {% for rec in crawlability_analysis.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                {% else %}
                <p style="color: var(--ne-text-secondary);">Crawlability analysis not available for this crawl.</p>
                {% endif %}

                <!-- Challenge/CAPTCHA Detection Section (STORY-INFRA-006) -->
                <h2 style="margin-top: 40px;">Bot Challenge Detection</h2>
                <p class="summary-intro">
                    Analyze CAPTCHA and bot detection challenges encountered during crawling.
                    Pages with challenges may block search engine bots and affect indexing.
                </p>

                {% if challenge_detection and challenge_detection.enabled %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h3>Challenge Status</h3>
                        <div class="score-display" style="{% if challenge_detection.status == 'clear' %}color: #2f855a;{% elif challenge_detection.status == 'low' %}color: var(--ne-gold);{% elif challenge_detection.status == 'medium' %}color: #ed8936;{% else %}color: #c53030;{% endif %}">
                            {% if challenge_detection.status == 'clear' %}‚úì{% else %}{{ challenge_detection.challenges_detected }}{% endif %}
                        </div>
                        <div class="score-label">
                            {% if challenge_detection.status == 'clear' %}No Challenges Detected{% else %}Challenges Found{% endif %}
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h3>Detection Summary</h3>
                        <div class="metric-row">
                            <span class="metric-label">Pages Analyzed</span>
                            <span class="metric-value">{{ challenge_detection.total_pages }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Challenges Found</span>
                            <span class="metric-value" style="{% if challenge_detection.challenges_detected > 0 %}color: #ed8936;{% endif %}">
                                {{ challenge_detection.challenges_detected }} ({{ challenge_detection.challenge_rate }}%)
                            </span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Blocking Challenges</span>
                            <span class="metric-value" style="{% if challenge_detection.blocking_challenges > 0 %}color: #c53030;{% endif %}">
                                {{ challenge_detection.blocking_challenges|default(0) }}
                            </span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Pages Skipped</span>
                            <span class="metric-value" style="{% if challenge_detection.pages_skipped > 0 %}color: #c53030;{% endif %}">
                                {{ challenge_detection.pages_skipped|default(0) }}
                            </span>
                        </div>
                    </div>

                    {% if challenge_detection.challenge_types %}
                    <div class="analysis-card">
                        <h3>Challenge Types</h3>
                        {% for type, count in challenge_detection.challenge_types.items() %}
                        <div class="metric-row">
                            <span class="metric-label">{{ type|replace('_', ' ')|title }}</span>
                            <span class="metric-value">{{ count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                {% if challenge_detection.pages_with_challenges and challenge_detection.challenges_detected > 0 %}
                <h3 style="margin-top: 24px;">Pages with Challenges</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Challenge Type</th>
                                <th>Impact</th>
                                <th>Blocking</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in challenge_detection.pages_with_challenges %}
                            <tr>
                                <td><a href="{{ page.url }}" target="_blank" style="color: var(--ne-gold);">{{ page.url|truncate(60) }}</a></td>
                                <td>{{ page.version|replace('_', ' ')|title }}</td>
                                <td style="{% if page.impact == 'high' %}color: #c53030;{% elif page.impact == 'medium' %}color: #ed8936;{% else %}color: var(--ne-gold);{% endif %}">
                                    {{ page.impact|title }}
                                </td>
                                <td style="{% if page.blocking %}color: #c53030;{% endif %}">
                                    {% if page.blocking %}Yes{% else %}No{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                {% if challenge_detection.has_issues %}
                <div class="remediation" style="margin-top: 24px;">
                    <div class="remediation-title">üõ°Ô∏è CHALLENGE DETECTION RECOMMENDATIONS</div>
                    <ul class="remediation-steps">
                        <li>Review pages with blocking challenges - they may be inaccessible to search engines</li>
                        <li>Consider implementing bot-friendly alternatives for critical pages</li>
                        <li>Use reCAPTCHA v3 instead of v2 where possible for better user and bot experience</li>
                        <li>Verify Google can still index pages by checking Search Console coverage report</li>
                        <li>Test pages with Google's Mobile-Friendly Test tool to verify rendering</li>
                    </ul>
                </div>
                {% endif %}
                {% else %}
                <p style="color: var(--ne-text-secondary);">Challenge detection data not available. Run a browser-based crawl to detect CAPTCHAs.</p>
                {% endif %}
            </div>

            <!-- Tab 7: Recommendations -->
            <div id="content7" class="tab-content">
                <h2>Recommendations</h2>
                <p class="summary-intro">
                    Comprehensive recommendations generated using the ICE framework (Impact √ó Confidence √ó Ease)
                    for prioritizing SEO improvements.
                </p>

                <div class="recommendations-text">{{ recommendations|markdown }}</div>
            </div>

            <!-- Tab 8: Historical Trends -->
            <div id="content8" class="tab-content">
                <h2>Historical SEO Trends</h2>
                <p class="summary-intro">
                    Track key SEO metrics over time to measure progress and identify long-term trends.
                </p>

                <div class="analysis-grid" style="grid-template-columns: 1fr;">
                    <div class="analysis-card">
                        <h3>Technical Score Over Time</h3>
                        <canvas id="technicalScoreTrendChart"></canvas>
                    </div>
                </div>
                <div class="analysis-grid" style="grid-template-columns: 1fr;">
                     <div class="analysis-card">
                        <h3>Total Issues Over Time</h3>
                        <canvas id="totalIssuesTrendChart"></canvas>
                    </div>
                </div>
                <div class="analysis-grid" style="grid-template-columns: 1fr;">
                    <div class="analysis-card">
                        <h3>Crawlable Pages Over Time</h3>
                        <canvas id="crawledPagesTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tab 9: Performance Statistics -->
            <div id="content9" class="tab-content">
                <h2>Performance Overview</h2>

                <!-- Mobile SEO Analysis -->
                <h3>Mobile SEO</h3>
                {% if mobile_analysis %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>Mobile Score</h4>
                        <div class="score-display">{{ mobile_analysis.avg_score|round(0) }}%</div>
                        <div class="score-label">Mobile Optimization</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Viewport Configuration</h4>
                        <div class="metric-row">
                            <span class="metric-label">Pages with Viewport</span>
                            <span class="metric-value">{{ mobile_analysis.viewport_count }}/{{ mobile_analysis.total_pages }}</span>
                        </div>
                    </div>
                    <div class="analysis-card">
                        <h4>Mobile Issues</h4>
                        {% if mobile_analysis.issues %}
                        <ul class="issue-list">
                            {% for issue in mobile_analysis.issues %}
                            <li>{{ issue }}</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <ul class="success-list">
                            <li>All pages have viewport meta tags</li>
                        </ul>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Core Web Vitals -->
                <h3 style="margin-top: 32px;">Core Web Vitals</h3>
                {% if cwv_analysis %}
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>LCP - Loading</h4>
                        <div class="score-display" style="font-size: 32px; {% if cwv_analysis.lcp_status == 'good' %}color: #2f855a;{% elif cwv_analysis.lcp_status == 'needs-improvement' %}color: #ed8936;{% else %}color: #c53030;{% endif %}">
                            {% if cwv_analysis.lcp_status == 'good' %}‚úì{% elif cwv_analysis.lcp_status == 'needs-improvement' %}‚ö†{% else %}‚úó{% endif %}
                        </div>
                        {% if cwv_analysis.avg_lcp_estimate %}
                        <p style="color: var(--ne-text-secondary); font-size: 13px; text-align: center;">{{ cwv_analysis.avg_lcp_estimate|round(2) }}s avg</p>
                        {% endif %}
                    </div>
                    <div class="analysis-card">
                        <h4>INP - Interactivity</h4>
                        <div class="score-display" style="font-size: 32px; {% if cwv_analysis.inp_status == 'good' %}color: #2f855a;{% elif cwv_analysis.inp_status == 'needs-improvement' %}color: #ed8936;{% else %}color: #c53030;{% endif %}">
                            {% if cwv_analysis.inp_status == 'good' %}‚úì{% elif cwv_analysis.inp_status == 'needs-improvement' %}‚ö†{% else %}‚úó{% endif %}
                        </div>
                        <p style="color: var(--ne-text-secondary); font-size: 13px; text-align: center;">{{ cwv_analysis.total_blocking_scripts }} blocking scripts</p>
                    </div>
                    <div class="analysis-card">
                        <h4>CLS - Stability</h4>
                        <div class="score-display" style="font-size: 32px; {% if cwv_analysis.cls_status == 'good' %}color: #2f855a;{% elif cwv_analysis.cls_status == 'needs-improvement' %}color: #ed8936;{% else %}color: #c53030;{% endif %}">
                            {% if cwv_analysis.cls_status == 'good' %}‚úì{% elif cwv_analysis.cls_status == 'needs-improvement' %}‚ö†{% else %}‚úó{% endif %}
                        </div>
                        <p style="color: var(--ne-text-secondary); font-size: 13px; text-align: center;">{{ cwv_analysis.total_cls_risks }} CLS risks</p>
                    </div>
                </div>

                {% if cwv_analysis.pages_needing_improvement %}
                <h4 style="margin-top: 16px;">Pages Needing CWV Improvement</h4>
                <table id="cwvTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable('cwvTable', 0, 'cwv')">URL <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('cwvTable', 1, 'cwv')">LCP <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('cwvTable', 2, 'cwv')">INP <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('cwvTable', 3, 'cwv')">CLS <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for page in cwv_analysis.pages_needing_improvement[:10] %}
                        <tr>
                            <td class="url-cell">{{ page.url }}</td>
                            <td style="text-align: center; {% if page.lcp_status == 'good' %}color: #2f855a;{% elif page.lcp_status == 'needs-improvement' %}color: #ed8936;{% else %}color: #c53030;{% endif %}">{{ page.lcp_status|upper }}</td>
                            <td style="text-align: center; {% if page.inp_status == 'good' %}color: #2f855a;{% elif page.inp_status == 'needs-improvement' %}color: #ed8936;{% else %}color: #c53030;{% endif %}">{{ page.inp_status|upper }}</td>
                            <td style="text-align: center; {% if page.cls_status == 'good' %}color: #2f855a;{% elif page.cls_status == 'needs-improvement' %}color: #ed8936;{% else %}color: #c53030;{% endif %}">{{ page.cls_status|upper }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
                {% endif %}

                <!-- Lighthouse Analysis -->
                {% if lighthouse_analysis and lighthouse_analysis.enabled %}
                <h3 style="margin-top: 32px;">Lighthouse Scores</h3>
                <p style="color: var(--ne-text-secondary); font-size: 14px; margin-bottom: 8px;">
                    {{ lighthouse_analysis.pages_audited }} of {{ lighthouse_analysis.total_pages }} pages analyzed
                    ({{ lighthouse_analysis.coverage_percentage|round(0)|int }}% coverage)
                </p>
                {% if lighthouse_analysis.coverage_percentage < 90 %}
                <div style="background: #fefcbf; border-left: 4px solid #d69e2e; padding: 12px 16px; margin-bottom: 16px;">
                    <strong style="color: #744210;">Low PSI Coverage Warning:</strong>
                    <span style="color: #744210;">{{ lighthouse_analysis.total_pages - lighthouse_analysis.pages_audited }} pages are missing Lighthouse data.
                    Run <code style="background: #edf2f7; padding: 2px 6px; font-size: 13px;">python backfill_psi.py &lt;crawl_dir&gt;</code> to fetch missing data.</span>
                </div>
                {% endif %}

                <div class="analysis-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                    <div class="analysis-card" style="text-align: center;">
                        <h4>Performance</h4>
                        <canvas id="lighthousePerformanceGauge" width="120" height="120"></canvas>
                    </div>
                    <div class="analysis-card" style="text-align: center;">
                        <h4>Accessibility</h4>
                        <canvas id="lighthouseAccessibilityGauge" width="120" height="120"></canvas>
                    </div>
                    <div class="analysis-card" style="text-align: center;">
                        <h4>Best Practices</h4>
                        <canvas id="lighthouseBestPracticesGauge" width="120" height="120"></canvas>
                    </div>
                    <div class="analysis-card" style="text-align: center;">
                        <h4>SEO</h4>
                        <canvas id="lighthouseSeoGauge" width="120" height="120"></canvas>
                    </div>
                </div>

                {% if lighthouse_analysis.top_opportunities %}
                <h4 style="margin-top: 24px;">Top Optimization Opportunities</h4>
                <table id="opportunitiesTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable('opportunitiesTable', 0, 'opp')">Opportunity <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('opportunitiesTable', 1, 'opp')">Pages <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('opportunitiesTable', 2, 'opp')">Savings <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for opp in lighthouse_analysis.top_opportunities[:8] %}
                        <tr>
                            <td><strong>{{ opp.title }}</strong></td>
                            <td style="text-align: center;">{{ opp.pages_affected|length }}</td>
                            <td style="text-align: center;">{% if opp.total_savings_ms > 0 %}<span style="color: #ed8936;">{{ (opp.total_savings_ms / 1000)|round(1) }}s</span>{% else %}-{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}

                {% if lighthouse_analysis.poor_performance_pages %}
                <h4 style="margin-top: 24px;">Pages Needing Attention (Perf &lt; 50)</h4>
                <table id="poorPerfTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable('poorPerfTable', 0, 'poorPerf')">URL <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('poorPerfTable', 1, 'poorPerf')">Perf <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('poorPerfTable', 2, 'poorPerf')">LCP <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="cursor: pointer; text-align: center;" onclick="sortTable('poorPerfTable', 3, 'poorPerf')">TBT <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span></th>
                            <th style="text-align: center; width: 50px;">PSI</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for page in lighthouse_analysis.poor_performance_pages[:10] %}
                        <tr>
                            <td class="url-cell">{{ page.url }}</td>
                            <td style="text-align: center; color: #c53030; font-weight: bold;">{{ page.performance_score|int }}</td>
                            <td style="text-align: center;">{% if page.lcp %}{{ (page.lcp / 1000)|round(1) }}s{% else %}-{% endif %}</td>
                            <td style="text-align: center;">{% if page.tbt %}{{ page.tbt|int }}ms{% else %}-{% endif %}</td>
                            <td style="text-align: center;">
                                <a href="javascript:void(0)" onclick="showPsiModal('{{ page.url|url_to_filename }}')"
                                   style="text-decoration: none; font-size: 12px; cursor: pointer;" title="View PSI Report">üìÑ</a>
                                <a href="https://pagespeed.web.dev/analysis?url={{ page.url|urlencode }}" target="_blank" rel="noopener"
                                   style="text-decoration: none; font-size: 12px; margin-left: 4px;" title="Fresh PSI Analysis">üîÑ</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}

                <div class="remediation" style="margin-top: 24px;">
                    <div class="remediation-title">üí° PERFORMANCE TIPS</div>
                    <ul class="remediation-steps">
                        <li>Implement image optimization: compress, use WebP/AVIF, add lazy loading</li>
                        <li>Minimize and defer JavaScript to reduce Total Blocking Time</li>
                        <li>Add width/height to images to prevent layout shifts</li>
                        {% if technology_analysis.has_cdn and technology_analysis.cdns %}
                        <li>‚úì CDN detected ({{ technology_analysis.cdns | join(', ') }}) ‚Äî optimize cache TTLs</li>
                        {% else %}
                        <li>Use a CDN to reduce server response times</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}

                <!-- PageSpeed Insights Statistics -->
                <h3 style="margin-top: 32px;">PageSpeed Insights Statistics</h3>
                {% if performance_statistics and performance_statistics.enabled %}
                <p class="summary-intro">
                    Aggregate metrics across {{ performance_statistics.pages_analyzed }} pages analyzed.
                </p>

                <!-- Aggregate Stats Summary Cards -->
                <div class="stats-grid" style="margin-bottom: 32px;">
                    {% if performance_statistics.stats.performance_score %}
                    <div class="stat-card">
                        <div class="stat-value">{{ performance_statistics.stats.performance_score.avg|round(0)|int }}</div>
                        <div class="stat-label">Avg Performance</div>
                        <div style="font-size: 12px; color: var(--ne-text-secondary); margin-top: 4px;">
                            Median: {{ performance_statistics.stats.performance_score.median|round(0)|int }} |
                            P90: {{ performance_statistics.stats.performance_score.p90|round(0)|int }}
                        </div>
                    </div>
                    {% endif %}
                    {% if performance_statistics.stats.accessibility_score %}
                    <div class="stat-card">
                        <div class="stat-value">{{ performance_statistics.stats.accessibility_score.avg|round(0)|int }}</div>
                        <div class="stat-label">Avg Accessibility</div>
                        <div style="font-size: 12px; color: var(--ne-text-secondary); margin-top: 4px;">
                            Median: {{ performance_statistics.stats.accessibility_score.median|round(0)|int }} |
                            P90: {{ performance_statistics.stats.accessibility_score.p90|round(0)|int }}
                        </div>
                    </div>
                    {% endif %}
                    {% if performance_statistics.stats.best_practices_score %}
                    <div class="stat-card">
                        <div class="stat-value">{{ performance_statistics.stats.best_practices_score.avg|round(0)|int }}</div>
                        <div class="stat-label">Avg Best Practices</div>
                        <div style="font-size: 12px; color: var(--ne-text-secondary); margin-top: 4px;">
                            Median: {{ performance_statistics.stats.best_practices_score.median|round(0)|int }} |
                            P90: {{ performance_statistics.stats.best_practices_score.p90|round(0)|int }}
                        </div>
                    </div>
                    {% endif %}
                    {% if performance_statistics.stats.seo_score %}
                    <div class="stat-card">
                        <div class="stat-value">{{ performance_statistics.stats.seo_score.avg|round(0)|int }}</div>
                        <div class="stat-label">Avg SEO Score</div>
                        <div style="font-size: 12px; color: var(--ne-text-secondary); margin-top: 4px;">
                            Median: {{ performance_statistics.stats.seo_score.median|round(0)|int }} |
                            P90: {{ performance_statistics.stats.seo_score.p90|round(0)|int }}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Core Web Vitals Stats -->
                <h3 style="margin-bottom: 16px;">Core Web Vitals Statistics</h3>
                <div class="stats-grid" style="margin-bottom: 32px;">
                    {% if performance_statistics.stats.lcp %}
                    <div class="stat-card">
                        <div class="stat-value">{{ (performance_statistics.stats.lcp.avg / 1000)|round(2) }}s</div>
                        <div class="stat-label">Avg LCP</div>
                        <div style="font-size: 12px; color: var(--ne-text-secondary); margin-top: 4px;">
                            Median: {{ (performance_statistics.stats.lcp.median / 1000)|round(2) }}s |
                            P90: {{ (performance_statistics.stats.lcp.p90 / 1000)|round(2) }}s
                        </div>
                        <div style="font-size: 11px; color: #a0aec0; margin-top: 2px;">
                            StdDev: {{ (performance_statistics.stats.lcp.stddev / 1000)|round(2) }}s
                        </div>
                    </div>
                    {% endif %}
                    {% if performance_statistics.stats.cls %}
                    <div class="stat-card">
                        <div class="stat-value">{{ performance_statistics.stats.cls.avg|round(3) }}</div>
                        <div class="stat-label">Avg CLS</div>
                        <div style="font-size: 12px; color: var(--ne-text-secondary); margin-top: 4px;">
                            Median: {{ performance_statistics.stats.cls.median|round(3) }} |
                            P90: {{ performance_statistics.stats.cls.p90|round(3) }}
                        </div>
                        <div style="font-size: 11px; color: #a0aec0; margin-top: 2px;">
                            StdDev: {{ performance_statistics.stats.cls.stddev|round(3) }}
                        </div>
                    </div>
                    {% endif %}
                    {% if performance_statistics.stats.tbt %}
                    <div class="stat-card">
                        <div class="stat-value">{{ performance_statistics.stats.tbt.avg|round(0)|int }}ms</div>
                        <div class="stat-label">Avg TBT</div>
                        <div style="font-size: 12px; color: var(--ne-text-secondary); margin-top: 4px;">
                            Median: {{ performance_statistics.stats.tbt.median|round(0)|int }}ms |
                            P90: {{ performance_statistics.stats.tbt.p90|round(0)|int }}ms
                        </div>
                        <div style="font-size: 11px; color: #a0aec0; margin-top: 2px;">
                            StdDev: {{ performance_statistics.stats.tbt.stddev|round(0)|int }}ms
                        </div>
                    </div>
                    {% endif %}
                    {% if performance_statistics.stats.fcp %}
                    <div class="stat-card">
                        <div class="stat-value">{{ (performance_statistics.stats.fcp.avg / 1000)|round(2) }}s</div>
                        <div class="stat-label">Avg FCP</div>
                        <div style="font-size: 12px; color: var(--ne-text-secondary); margin-top: 4px;">
                            Median: {{ (performance_statistics.stats.fcp.median / 1000)|round(2) }}s |
                            P90: {{ (performance_statistics.stats.fcp.p90 / 1000)|round(2) }}s
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sortable Performance Table -->
                <h3 style="margin-bottom: 16px;">Performance by Page</h3>
                <div class="perf-legend">
                    <span><strong>Perf</strong> = Performance Score</span>
                    <span><strong>A11y</strong> = Accessibility</span>
                    <span><strong>BP</strong> = Best Practices</span>
                    <span><strong>LCP</strong> = Largest Contentful Paint</span>
                    <span><strong>CLS</strong> = Cumulative Layout Shift</span>
                    <span><strong>TBT</strong> = Total Blocking Time</span>
                </div>
                <div style="margin-bottom: 16px;">
                    <input type="text" id="perfTableFilter" placeholder="Filter by title..."
                           style="padding: 8px 12px; border: 1px solid var(--ne-border-light); border-radius: 0; width: 300px;"
                           oninput="filterPerfTable(this.value)">
                </div>
                <div style="overflow-x: auto;">
                    <table id="perfTable" style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--ne-dark); color: #fff;">
                            <tr>
                                <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortPerfTable(0)">Title <span class="sort-arrow">&#x25B2;&#x25BC;</span></th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; width: 80px;" onclick="sortPerfTable(1)">Perf <span class="sort-arrow">&#x25B2;&#x25BC;</span></th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; width: 80px;" onclick="sortPerfTable(2)">A11y <span class="sort-arrow">&#x25B2;&#x25BC;</span></th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; width: 80px;" onclick="sortPerfTable(3)">BP <span class="sort-arrow">&#x25B2;&#x25BC;</span></th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; width: 80px;" onclick="sortPerfTable(4)">SEO <span class="sort-arrow">&#x25B2;&#x25BC;</span></th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; width: 90px;" onclick="sortPerfTable(5)">LCP <span class="sort-arrow">&#x25B2;&#x25BC;</span></th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; width: 80px;" onclick="sortPerfTable(6)">CLS <span class="sort-arrow">&#x25B2;&#x25BC;</span></th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; width: 90px;" onclick="sortPerfTable(7)">TBT <span class="sort-arrow">&#x25B2;&#x25BC;</span></th>
                                <th style="padding: 12px; text-align: center; width: 50px;">PSI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in performance_statistics.pages %}
                            <tr style="border-bottom: 1px solid var(--ne-border-light);">
                                <td style="padding: 12px;">
                                    <a href="{{ page.url }}" target="_blank" style="color: var(--ne-gold); text-decoration: none;">
                                        {{ page.title|truncate(60) }}
                                    </a>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if page.performance_score %}
                                    <span style="display: inline-block; padding: 4px 8px; border-radius: 0; font-weight: 600;
                                        {% if page.performance_score >= 90 %}background: #c6f6d5; color: #22543d;
                                        {% elif page.performance_score >= 50 %}background: #fefcbf; color: #744210;
                                        {% else %}background: #fed7d7; color: #822727;{% endif %}">
                                        {{ page.performance_score|round(0)|int }}
                                    </span>
                                    {% else %}-{% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if page.accessibility_score %}
                                    <span style="display: inline-block; padding: 4px 8px; border-radius: 0; font-weight: 600;
                                        {% if page.accessibility_score >= 90 %}background: #c6f6d5; color: #22543d;
                                        {% elif page.accessibility_score >= 50 %}background: #fefcbf; color: #744210;
                                        {% else %}background: #fed7d7; color: #822727;{% endif %}">
                                        {{ page.accessibility_score|round(0)|int }}
                                    </span>
                                    {% else %}-{% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if page.best_practices_score %}
                                    <span style="display: inline-block; padding: 4px 8px; border-radius: 0; font-weight: 600;
                                        {% if page.best_practices_score >= 90 %}background: #c6f6d5; color: #22543d;
                                        {% elif page.best_practices_score >= 50 %}background: #fefcbf; color: #744210;
                                        {% else %}background: #fed7d7; color: #822727;{% endif %}">
                                        {{ page.best_practices_score|round(0)|int }}
                                    </span>
                                    {% else %}-{% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if page.seo_score %}
                                    <span style="display: inline-block; padding: 4px 8px; border-radius: 0; font-weight: 600;
                                        {% if page.seo_score >= 90 %}background: #c6f6d5; color: #22543d;
                                        {% elif page.seo_score >= 50 %}background: #fefcbf; color: #744210;
                                        {% else %}background: #fed7d7; color: #822727;{% endif %}">
                                        {{ page.seo_score|round(0)|int }}
                                    </span>
                                    {% else %}-{% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if page.lcp %}{{ (page.lcp / 1000)|round(2) }}s{% else %}-{% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if page.cls is not none %}{{ page.cls|round(3) }}{% else %}-{% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    {% if page.tbt %}{{ page.tbt|round(0)|int }}ms{% else %}-{% endif %}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <a href="javascript:void(0)" onclick="showPsiModal('{{ page.url|url_to_filename }}')"
                                       style="text-decoration: none; font-size: 12px; cursor: pointer;" title="View PSI Report">üìÑ</a>
                                    <a href="https://pagespeed.web.dev/analysis?url={{ page.url|urlencode }}" target="_blank" rel="noopener"
                                       style="text-decoration: none; font-size: 12px; margin-left: 4px;" title="Fresh PSI Analysis">üîÑ</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="analysis-card">
                    <p style="color: var(--ne-text-secondary); text-align: center; padding: 40px;">
                        No PageSpeed Insights data available. Run the crawler with PSI enabled to see performance statistics.
                    </p>
                </div>
                {% endif %}
            </div>

            <!-- Tab 10: All Pages Matrix -->
            <div id="content10" class="tab-content">
                <h2>All Pages Health Matrix</h2>
                <p class="summary-intro">
                    Complete listing of all {{ page_matrix.total_pages }} crawled pages with health indicators and scores.
                    Click column headers to sort. URLs open in new tabs.
                </p>

                {% if page_matrix.pages %}
                <!-- Issue Summary -->
                <div class="analysis-grid" style="margin-bottom: 24px;">
                    <div class="analysis-card">
                        <h3>Issue Summary</h3>
                        <div class="metric-row">
                            <span class="metric-label">Missing Titles</span>
                            <span class="metric-value {% if page_matrix.issue_counts.missing_title > 0 %}text-red{% endif %}">{{ page_matrix.issue_counts.missing_title }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Missing Descriptions</span>
                            <span class="metric-value {% if page_matrix.issue_counts.missing_description > 0 %}text-red{% endif %}">{{ page_matrix.issue_counts.missing_description }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Missing H1</span>
                            <span class="metric-value {% if page_matrix.issue_counts.missing_h1 > 0 %}text-red{% endif %}">{{ page_matrix.issue_counts.missing_h1 }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Missing Canonical</span>
                            <span class="metric-value {% if page_matrix.issue_counts.missing_canonical > 0 %}text-red{% endif %}">{{ page_matrix.issue_counts.missing_canonical }}</span>
                        </div>
                    </div>
                    <div class="analysis-card">
                        <h3>Content & Performance</h3>
                        <div class="metric-row">
                            <span class="metric-label">Thin Content (&lt;300 words)</span>
                            <span class="metric-value {% if page_matrix.issue_counts.thin_content > 0 %}text-orange{% endif %}">{{ page_matrix.issue_counts.thin_content }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Slow Load (&gt;3s)</span>
                            <span class="metric-value {% if page_matrix.issue_counts.slow_load > 0 %}text-orange{% endif %}">{{ page_matrix.issue_counts.slow_load }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Poor Performance (&lt;50)</span>
                            <span class="metric-value {% if page_matrix.issue_counts.poor_performance > 0 %}text-red{% endif %}">{{ page_matrix.issue_counts.poor_performance }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Console Errors</span>
                            <span class="metric-value {% if page_matrix.issue_counts.console_errors > 0 %}text-orange{% endif %}">{{ page_matrix.issue_counts.console_errors }}</span>
                        </div>
                    </div>
                    <div class="analysis-card">
                        <h3>Accessibility & Security</h3>
                        <div class="metric-row">
                            <span class="metric-label">Images Without Alt</span>
                            <span class="metric-value {% if page_matrix.issue_counts.images_no_alt > 0 %}text-orange{% endif %}">{{ page_matrix.issue_counts.images_no_alt }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">A11y Issues</span>
                            <span class="metric-value {% if page_matrix.issue_counts.a11y_issues > 0 %}text-orange{% endif %}">{{ page_matrix.issue_counts.a11y_issues }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Security Issues</span>
                            <span class="metric-value {% if page_matrix.issue_counts.security_issues > 0 %}text-red{% endif %}">{{ page_matrix.issue_counts.security_issues }}</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Redirected Pages</span>
                            <span class="metric-value">{{ page_matrix.issue_counts.redirected }}</span>
                        </div>
                    </div>
                </div>

                <!-- Search/Filter -->
                <div style="margin-bottom: 16px;">
                    <input type="text" id="pageMatrixSearch" placeholder="Filter by URL or title..."
                           oninput="filterPageMatrix(this.value)"
                           style="width: 300px; padding: 8px 12px; border: 1px solid var(--ne-border-light); border-radius: 0; font-size: 14px;">
                </div>

                <!-- Page Matrix Table -->
                <div style="overflow-x: auto;">
                    <table id="pageMatrixTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: var(--ne-dark); color: #ffffff;">
                                <th style="padding: 10px; text-align: left; cursor: pointer; min-width: 250px;" onclick="sortTable('pageMatrixTable', 0, 'matrix')">
                                    Page <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span>
                                </th>
                                <th style="padding: 10px; text-align: center; cursor: pointer; width: 70px;" onclick="sortTable('pageMatrixTable', 1, 'matrix')">
                                    Health <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span>
                                </th>
                                <th style="padding: 10px; text-align: center; cursor: pointer; width: 60px;" onclick="sortTable('pageMatrixTable', 2, 'matrix')">
                                    Perf <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span>
                                </th>
                                <th style="padding: 10px; text-align: center; cursor: pointer; width: 60px;" onclick="sortTable('pageMatrixTable', 3, 'matrix')">
                                    A11y <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span>
                                </th>
                                <th style="padding: 10px; text-align: center; cursor: pointer; width: 60px;" onclick="sortTable('pageMatrixTable', 4, 'matrix')">
                                    SEO <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span>
                                </th>
                                <th style="padding: 10px; text-align: center; cursor: pointer; width: 70px;" onclick="sortTable('pageMatrixTable', 5, 'matrix')">
                                    Words <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span>
                                </th>
                                <th style="padding: 10px; text-align: center; cursor: pointer; width: 70px;" onclick="sortTable('pageMatrixTable', 6, 'matrix')">
                                    Load <span class="sort-arrow" style="font-size: 10px; opacity: 0.4;">&#x25B2;&#x25BC;</span>
                                </th>
                                <th style="padding: 10px; text-align: left; min-width: 200px;">Issues</th>
                                <th style="padding: 10px; text-align: center; width: 50px;">PSI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in page_matrix.pages %}
                            <tr style="border-bottom: 1px solid var(--ne-border-light);">
                                <td style="padding: 10px;">
                                    <a href="{{ page.url }}" target="_blank" rel="noopener" style="color: var(--ne-gold); text-decoration: none; display: block;">
                                        <div style="font-weight: 500; margin-bottom: 2px;">{{ page.title }}</div>
                                        <div style="font-size: 11px; color: var(--ne-text-secondary); word-break: break-all;">{{ page.url }}</div>
                                    </a>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="display: inline-block; padding: 2px 8px; border-radius: 0; font-weight: 600; font-size: 12px;
                                        {% if page.health_score >= 80 %}background: #c6f6d5; color: #22543d;
                                        {% elif page.health_score >= 50 %}background: #fefcbf; color: #744210;
                                        {% else %}background: #fed7d7; color: #822727;{% endif %}">
                                        {{ page.health_score }}
                                    </span>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    {% if page.perf_score is not none %}
                                    <span style="{% if page.perf_score >= 90 %}color: #22543d;{% elif page.perf_score >= 50 %}color: #744210;{% else %}color: #822727;{% endif %}">
                                        {{ page.perf_score|round(0)|int }}
                                    </span>
                                    {% else %}<span style="color: #a0aec0; font-size: 11px;" title="Lighthouse data not available - run backfill_psi.py to fetch">N/A</span>{% endif %}
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    {% if page.a11y_score is not none %}
                                    <span style="{% if page.a11y_score >= 90 %}color: #22543d;{% elif page.a11y_score >= 50 %}color: #744210;{% else %}color: #822727;{% endif %}">
                                        {{ page.a11y_score|round(0)|int }}
                                    </span>
                                    {% else %}<span style="color: #a0aec0; font-size: 11px;" title="Lighthouse data not available - run backfill_psi.py to fetch">N/A</span>{% endif %}
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    {% if page.seo_score is not none %}
                                    <span style="{% if page.seo_score >= 90 %}color: #22543d;{% elif page.seo_score >= 50 %}color: #744210;{% else %}color: #822727;{% endif %}">
                                        {{ page.seo_score|round(0)|int }}
                                    </span>
                                    {% else %}<span style="color: #a0aec0; font-size: 11px;" title="Lighthouse data not available - run backfill_psi.py to fetch">N/A</span>{% endif %}
                                </td>
                                <td style="padding: 10px; text-align: center; {% if page.word_count < 300 %}color: #c53030;{% endif %}">
                                    {{ page.word_count }}
                                </td>
                                <td style="padding: 10px; text-align: center; {% if page.load_time and page.load_time > 3 %}color: #c53030;{% endif %}">
                                    {% if page.load_time %}{{ page.load_time }}s{% else %}-{% endif %}
                                </td>
                                <td style="padding: 10px;">
                                    {% if page.issues %}
                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                        {% for issue in page.issues %}
                                        <span style="display: inline-block; padding: 2px 6px; border-radius: 0; font-size: 10px; font-weight: 500;
                                            {% if issue in ['title', 'desc', 'h1', 'perf', 'security'] %}background: #fed7d7; color: #822727;
                                            {% else %}background: #fefcbf; color: #744210;{% endif %}">
                                            {{ issue }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <span style="color: #22543d; font-size: 11px;">‚úì No issues</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    {% if page.perf_score is not none %}
                                    <a href="javascript:void(0)" onclick="showPsiModal('{{ page.url|url_to_filename }}')"
                                       style="text-decoration: none; font-size: 12px; cursor: pointer;" title="View PSI Report">üìÑ</a>
                                    <a href="https://pagespeed.web.dev/analysis?url={{ page.url|urlencode }}" target="_blank" rel="noopener"
                                       style="text-decoration: none; font-size: 12px; margin-left: 4px;" title="Fresh PSI Analysis">üîÑ</a>
                                    {% else %}-{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Legend -->
                <div style="margin-top: 16px; padding: 12px; background: var(--ne-bg-alt); border-radius: 0; font-size: 12px; color: var(--ne-text);">
                    <strong>Issue codes:</strong>
                    <span style="margin-left: 8px;">title = missing title</span> ‚Ä¢
                    <span>desc = missing description</span> ‚Ä¢
                    <span>h1 = missing H1</span> ‚Ä¢
                    <span>canonical = missing canonical</span> ‚Ä¢
                    <span>thin = &lt;300 words</span> ‚Ä¢
                    <span>slow = &gt;3s load</span> ‚Ä¢
                    <span>perf = performance &lt;50</span> ‚Ä¢
                    <span>alt = images without alt</span> ‚Ä¢
                    <span>security = missing headers</span> ‚Ä¢
                    <span>errors = console errors</span> ‚Ä¢
                    <span>redirect = was redirected</span>
                </div>
                {% else %}
                <div class="analysis-card">
                    <p style="color: var(--ne-text-secondary); text-align: center; padding: 40px;">
                        No page data available.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <footer>
        <p>Generated by SEO Analyzer ‚Ä¢ {{ crawled_at }}</p>
    </footer>

    <script>
        // Use a self-invoking function to avoid polluting the global namespace
        (function() {
            // Track which charts have been initialized to avoid duplicates
            const initializedCharts = new Set();

            // Initialize charts for Tab 1 (Overview) - visible on page load
            function initializeTab1Charts() {
                console.log('[CHARTS] Initializing Tab 1 (Overview) charts');

                {% if advanced_summary %}
                // Spider/Radar Chart - Overall SEO Health
                if (!initializedCharts.has('radarChart')) {
                    const radarCtx = document.getElementById('radarChart');
                    if (radarCtx) {
                        try {
                            new Chart(radarCtx, {
                                type: 'radar',
                                data: {
                                    labels: ['Content Quality', 'Security', 'Mobile', 'Technical SEO', 'Performance'],
                                    datasets: [{
                                        label: 'SEO Health Score',
                                        data: [
                                            {{ advanced_summary.avg_readability|default(0)|round(0) }},
                                            {{ advanced_summary.avg_security_score|default(0)|round(0) }},
                                            {{ advanced_summary.avg_mobile_score|default(0)|round(0) }},
                                            {{ [0, ((total_pages - total_issues) / total_pages * 100)|round(0)]|max if total_pages > 0 else 0 }},
                                            {{ ((advanced_summary.https_pages|default(0) / total_pages) * 100)|round(0) if total_pages > 0 else 0 }}
                                        ],
                                        backgroundColor: 'rgba(44, 82, 130, 0.2)',
                                        borderColor: 'rgba(44, 82, 130, 1)',
                                        borderWidth: 2,
                                        pointBackgroundColor: 'rgba(44, 82, 130, 1)',
                                        pointBorderColor: '#fff',
                                        pointHoverBackgroundColor: '#fff',
                                        pointHoverBorderColor: 'rgba(44, 82, 130, 1)'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    scales: {
                                        r: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: {
                                                stepSize: 20
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            });
                            initializedCharts.add('radarChart');
                            console.log('[CHARTS] ‚úì Radar chart created');
                        } catch (error) {
                            console.error('[CHARTS] ‚úó Error creating radar chart:', error);
                        }
                    }
                }

                // Doughnut Chart - Issue Distribution
                if (!initializedCharts.has('issueChart')) {
                    const issueCtx = document.getElementById('issueChart');
                    if (issueCtx) {
                        try {
                            new Chart(issueCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Critical Priority', 'High Priority', 'Medium Priority'],
                                    datasets: [{
                                        data: [
                                            {{ critical_patterns|sum(attribute='count') }},
                                            {{ high_patterns|sum(attribute='count') }},
                                            {{ medium_patterns|sum(attribute='count') }}
                                        ],
                                        backgroundColor: [
                                            'rgba(197, 48, 48, 0.8)',
                                            'rgba(229, 62, 62, 0.8)',
                                            'rgba(237, 137, 54, 0.8)'
                                        ],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    plugins: {
                                        legend: {
                                            position: 'bottom'
                                        }
                                    }
                                }
                            });
                            initializedCharts.add('issueChart');
                            console.log('[CHARTS] ‚úì Issue chart created');
                        } catch (error) {
                            console.error('[CHARTS] ‚úó Error creating issue chart:', error);
                        }
                    }
                }
                {% endif %}
            }

            // Initialize charts for Tab 3 (Content Quality)
            function initializeTab3Charts() {
                console.log('[CHARTS] Initializing Tab 3 (Content Quality) charts');

                {% if content_quality %}
                if (!initializedCharts.has('readabilityChart')) {
                    const readabilityCtx = document.getElementById('readabilityChart');
                    if (readabilityCtx) {
                        try {
                            const ranges = {
                                'Very Easy (90-100)': 0, 'Easy (80-89)': 0, 'Fairly Easy (70-79)': 0,
                                'Standard (60-69)': 0, 'Fairly Difficult (50-59)': 0, 'Difficult (0-49)': 0
                            };
                            {% for page in content_quality.top_pages %}
                            const score_{{ loop.index }} = {{ page.readability_score }};
                            if (score_{{ loop.index }} >= 90) ranges['Very Easy (90-100)']++;
                            else if (score_{{ loop.index }} >= 80) ranges['Easy (80-89)']++;
                            else if (score_{{ loop.index }} >= 70) ranges['Fairly Easy (70-79)']++;
                            else if (score_{{ loop.index }} >= 60) ranges['Standard (60-69)']++;
                            else if (score_{{ loop.index }} >= 50) ranges['Fairly Difficult (50-59)']++;
                            else ranges['Difficult (0-49)']++;
                            {% endfor %}

                            new Chart(readabilityCtx, {
                                type: 'bar',
                                data: {
                                    labels: Object.keys(ranges),
                                    datasets: [{
                                        label: 'Number of Pages',
                                        data: Object.values(ranges),
                                        backgroundColor: [
                                            'rgba(47, 133, 90, 0.8)',
                                            'rgba(56, 178, 172, 0.8)',
                                            'rgba(49, 130, 206, 0.8)',
                                            'rgba(237, 137, 54, 0.8)',
                                            'rgba(229, 62, 62, 0.8)',
                                            'rgba(197, 48, 48, 0.8)'
                                        ],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                stepSize: 1
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            });
                            initializedCharts.add('readabilityChart');
                            console.log('[CHARTS] ‚úì Readability chart created');
                        } catch (error) {
                            console.error('[CHARTS] ‚úó Error creating readability chart:', error);
                        }
                    }
                }
                {% endif %}
            }

            // Initialize charts for Tab 4 (Security & Mobile)
            function initializeTab4Charts() {
                console.log('[CHARTS] Initializing Tab 4 (Security & Mobile) charts');

                {% if security_analysis and mobile_analysis %}
                if (!initializedCharts.has('scoresChart')) {
                    const scoresCtx = document.getElementById('scoresChart');
                    if (scoresCtx) {
                        try {
                            new Chart(scoresCtx, {
                                type: 'bar',
                                data: {
                                    labels: ['Security Score', 'Mobile Score', 'HTTPS Coverage'],
                                    datasets: [{
                                        label: 'Score (%)',
                                        data: [
                                            {{ security_analysis.avg_score|round(0) }},
                                            {{ mobile_analysis.avg_score|round(0) }},
                                            {{ (security_analysis.https_count / security_analysis.total_pages * 100)|round(0) }}
                                        ],
                                        backgroundColor: [
                                            'rgba(44, 82, 130, 0.8)',
                                            'rgba(49, 130, 206, 0.8)',
                                            'rgba(47, 133, 90, 0.8)'
                                        ],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: {
                                                callback: function(value) {
                                                    return value + '%';
                                                }
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            });
                            initializedCharts.add('scoresChart');
                            console.log('[CHARTS] ‚úì Scores chart created');
                        } catch (error) {
                            console.error('[CHARTS] ‚úó Error creating scores chart:', error);
                        }
                    }
                }
                {% endif %}
            }

            // Initialize charts for Tab 7 (Historical Trends)
            function initializeTab7Charts() {
                console.log('[CHARTS] Initializing Tab 7 (Historical Trends) charts');

                const historicalData = {{ historical_snapshots|tojson|safe if historical_snapshots else '[]' }};

                if (historicalData.length > 1) {
                    const labels = historicalData.map(d => new Date(d.crawl_date).toLocaleDateString());

                    const createTrendChart = (elementId, label, dataKey, color) => {
                        if (initializedCharts.has(elementId)) return;

                        const ctx = document.getElementById(elementId);
                        if (!ctx) return;

                        try {
                            const data = historicalData.map(d => d[dataKey] || 0);
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: label,
                                        data: data,
                                        fill: true,
                                        backgroundColor: `rgba(${color}, 0.1)`,
                                        borderColor: `rgb(${color})`,
                                        tension: 0.1,
                                        pointRadius: 3,
                                        pointBackgroundColor: `rgb(${color})`
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    scales: {
                                        y: {
                                            beginAtZero: false
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            });
                            initializedCharts.add(elementId);
                            console.log(`[CHARTS] ‚úì ${label} chart created`);
                        } catch (error) {
                            console.error(`[CHARTS] ‚úó Error creating ${label} chart:`, error);
                        }
                    };

                    createTrendChart('technicalScoreTrendChart', 'Technical Score', 'technical_score', '49, 130, 206');
                    createTrendChart('totalIssuesTrendChart', 'Total Issues', 'total_issues', '229, 62, 62');
                    createTrendChart('crawledPagesTrendChart', 'Crawlable Pages', 'crawlable_pages', '47, 133, 90');
                }
            }

            // Set up tab click listeners to initialize charts when tabs become visible
            function setupTabListeners() {
                console.log('[CHARTS] Setting up tab click listeners');

                // Tab 1 - Overview (initialize immediately, it's visible by default)
                document.getElementById('tab1').addEventListener('change', function() {
                    if (this.checked) {
                        setTimeout(initializeTab1Charts, 100);
                    }
                });

                // Tab 3 - Content Quality
                document.getElementById('tab3').addEventListener('change', function() {
                    if (this.checked) {
                        setTimeout(initializeTab3Charts, 100);
                    }
                });

                // Tab 5 - Security & Mobile
                document.getElementById('tab5').addEventListener('change', function() {
                    if (this.checked) {
                        setTimeout(initializeTab4Charts, 100);
                    }
                });

                // Tab 8 - Historical Trends
                document.getElementById('tab8').addEventListener('change', function() {
                    if (this.checked) {
                        setTimeout(initializeTab7Charts, 100);
                    }
                });
            }

            // Lighthouse Gauge Charts
            function initializeLighthouseCharts() {
                {% if lighthouse_analysis and lighthouse_analysis.enabled %}
                // Helper function to create gauge chart
                function createGaugeChart(canvasId, score, label) {
                    const ctx = document.getElementById(canvasId);
                    if (!ctx) return;

                    // Determine color based on score
                    let color;
                    if (score >= 90) {
                        color = '#0cce6b'; // Green (Lighthouse green)
                    } else if (score >= 50) {
                        color = '#ffa400'; // Orange
                    } else {
                        color = '#ff4e42'; // Red
                    }

                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [score, 100 - score],
                                backgroundColor: [color, '#e0e0e0'],
                                borderWidth: 0,
                                circumference: 270,
                                rotation: 225
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            cutout: '75%',
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false
                                }
                            }
                        },
                        plugins: [{
                            id: 'centerText',
                            beforeDraw: function(chart) {
                                const width = chart.width;
                                const height = chart.height;
                                const ctx = chart.ctx;
                                ctx.restore();

                                const fontSize = (height / 100).toFixed(2);
                                ctx.font = 'bold ' + (fontSize * 24) + 'px sans-serif';
                                ctx.textBaseline = 'middle';
                                ctx.fillStyle = color;

                                const text = Math.round(score).toString();
                                const textX = Math.round((width - ctx.measureText(text).width) / 2);
                                const textY = height / 2;

                                ctx.fillText(text, textX, textY);
                                ctx.save();
                            }
                        }]
                    });
                }

                // Create all gauge charts
                createGaugeChart('lighthousePerformanceGauge', {{ lighthouse_analysis.avg_performance_score }}, 'Performance');
                createGaugeChart('lighthouseAccessibilityGauge', {{ lighthouse_analysis.avg_accessibility_score }}, 'Accessibility');
                createGaugeChart('lighthouseBestPracticesGauge', {{ lighthouse_analysis.avg_best_practices_score }}, 'Best Practices');
                createGaugeChart('lighthouseSeoGauge', {{ lighthouse_analysis.avg_seo_score }}, 'SEO');
                createGaugeChart('lighthousePwaGauge', {{ lighthouse_analysis.avg_pwa_score }}, 'PWA');

                // Metrics Bar Chart
                const metricsCtx = document.getElementById('lighthouseMetricsChart');
                if (metricsCtx) {
                    const metrics = [];
                    const values = [];
                    const colors = [];
                    const thresholds = [];

                    {% if lighthouse_analysis.avg_fcp %}
                    metrics.push('FCP');
                    values.push({{ lighthouse_analysis.avg_fcp / 1000 }});
                    colors.push({{ lighthouse_analysis.avg_fcp }} <= 1800 ? '#0cce6b' : {{ lighthouse_analysis.avg_fcp }} <= 3000 ? '#ffa400' : '#ff4e42');
                    thresholds.push(1.8);
                    {% endif %}

                    {% if lighthouse_analysis.avg_lcp %}
                    metrics.push('LCP');
                    values.push({{ lighthouse_analysis.avg_lcp / 1000 }});
                    colors.push({{ lighthouse_analysis.avg_lcp }} <= 2500 ? '#0cce6b' : {{ lighthouse_analysis.avg_lcp }} <= 4000 ? '#ffa400' : '#ff4e42');
                    thresholds.push(2.5);
                    {% endif %}

                    {% if lighthouse_analysis.avg_si %}
                    metrics.push('SI');
                    values.push({{ lighthouse_analysis.avg_si / 1000 }});
                    colors.push({{ lighthouse_analysis.avg_si }} <= 3400 ? '#0cce6b' : {{ lighthouse_analysis.avg_si }} <= 5800 ? '#ffa400' : '#ff4e42');
                    thresholds.push(3.4);
                    {% endif %}

                    {% if lighthouse_analysis.avg_tti %}
                    metrics.push('TTI');
                    values.push({{ lighthouse_analysis.avg_tti / 1000 }});
                    colors.push({{ lighthouse_analysis.avg_tti }} <= 3800 ? '#0cce6b' : {{ lighthouse_analysis.avg_tti }} <= 7300 ? '#ffa400' : '#ff4e42');
                    thresholds.push(3.8);
                    {% endif %}

                    {% if lighthouse_analysis.avg_tbt %}
                    metrics.push('TBT');
                    values.push({{ lighthouse_analysis.avg_tbt }});
                    colors.push({{ lighthouse_analysis.avg_tbt }} <= 200 ? '#0cce6b' : {{ lighthouse_analysis.avg_tbt }} <= 600 ? '#ffa400' : '#ff4e42');
                    thresholds.push(200);
                    {% endif %}

                    {% if lighthouse_analysis.avg_cls %}
                    metrics.push('CLS');
                    values.push({{ lighthouse_analysis.avg_cls }} * 100);
                    colors.push({{ lighthouse_analysis.avg_cls }} <= 0.1 ? '#0cce6b' : {{ lighthouse_analysis.avg_cls }} <= 0.25 ? '#ffa400' : '#ff4e42');
                    thresholds.push(10);
                    {% endif %}

                    new Chart(metricsCtx, {
                        type: 'bar',
                        data: {
                            labels: metrics,
                            datasets: [{
                                label: 'Actual',
                                data: values,
                                backgroundColor: colors,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const metric = context.label;
                                            let value = context.parsed.y;
                                            if (metric === 'CLS') {
                                                value = (value / 100).toFixed(3);
                                                return 'CLS: ' + value;
                                            } else if (metric === 'TBT') {
                                                return metric + ': ' + Math.round(value) + 'ms';
                                            } else {
                                                return metric + ': ' + value.toFixed(1) + 's';
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(1);
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
                {% endif %}
            }

            // Initialize on page load
            function initialize() {
                console.log('[CHARTS] Chart.js loaded, version:', Chart.version);
                console.log('[CHARTS] DOM ready state:', document.readyState);

                // Set up tab listeners
                setupTabListeners();

                // Initialize Tab 1 charts immediately (visible by default)
                initializeTab1Charts();

                // Initialize Lighthouse charts (Tab 5)
                initializeLighthouseCharts();
            }

            // Wait for Chart.js and DOM to be ready
            if (typeof Chart !== 'undefined') {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initialize);
                } else {
                    initialize();
                }
            } else {
                setTimeout(function() {
                    if (typeof Chart !== 'undefined') {
                        initialize();
                    } else {
                        console.error('[CHARTS] Chart.js failed to load from CDN');
                    }
                }, 1000);
            }

        })(); // End self-invoking function

        // Performance table sorting and filtering
        let perfSortColumn = -1;
        let perfSortAsc = true;

        function sortPerfTable(columnIndex) {
            sortTable('perfTable', columnIndex, 'perf');
        }

        // Generic table sorting - tracks state per table
        const tableSortState = {};

        function sortTable(tableId, columnIndex, stateKey) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Initialize or toggle sort state
            if (!tableSortState[stateKey]) {
                tableSortState[stateKey] = { column: -1, asc: true };
            }
            const state = tableSortState[stateKey];

            if (state.column === columnIndex) {
                state.asc = !state.asc;
            } else {
                state.column = columnIndex;
                state.asc = true;
            }

            rows.sort((a, b) => {
                const aCell = a.children[columnIndex];
                const bCell = b.children[columnIndex];
                if (!aCell || !bCell) return 0;

                const aText = aCell.textContent.trim();
                const bText = bCell.textContent.trim();

                // Try numeric parse first
                const aNum = parseFloat(aText.replace(/[^\d.-]/g, ''));
                const bNum = parseFloat(bText.replace(/[^\d.-]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return state.asc ? aNum - bNum : bNum - aNum;
                } else {
                    // Text sort
                    return state.asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
                }
            });

            rows.forEach(row => tbody.appendChild(row));

            // Update sort indicators
            const headers = table.querySelectorAll('th');
            headers.forEach((th, idx) => {
                const arrow = th.querySelector('.sort-arrow');
                if (arrow) {
                    if (idx === columnIndex) {
                        arrow.innerHTML = state.asc ? '&#x25B2;' : '&#x25BC;';
                        arrow.style.opacity = '0.8';
                    } else {
                        arrow.innerHTML = '&#x25B2;&#x25BC;';
                        arrow.style.opacity = '0.4';
                    }
                }
            });
        }

        function filterPerfTable(query) {
            const table = document.getElementById('perfTable');
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const lowerQuery = query.toLowerCase();

            rows.forEach(row => {
                const title = row.children[0].textContent.toLowerCase();
                row.style.display = title.includes(lowerQuery) ? '' : 'none';
            });
        }

        function filterPageMatrix(query) {
            const table = document.getElementById('pageMatrixTable');
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const lowerQuery = query.toLowerCase();

            rows.forEach(row => {
                const pageCell = row.children[0].textContent.toLowerCase();
                row.style.display = pageCell.includes(lowerQuery) ? '' : 'none';
            });
        }

        // =====================================================================
        // PSI Modal Viewer
        // =====================================================================

        // Embedded PSI data (works offline, no fetch needed)
        const psiData = {{ psi_data | tojson | safe }};

        function getScoreClass(score) {
            if (score >= 90) return 'good';
            if (score >= 50) return 'needs-improvement';
            return 'poor';
        }

        function formatTime(ms) {
            if (ms === null || ms === undefined) return 'N/A';
            return (ms / 1000).toFixed(1) + 's';
        }

        function showPsiModal(key) {
            const data = psiData[key];
            if (!data) {
                alert('PSI data not found for this page.');
                return;
            }

            const modal = document.getElementById('psiModal');
            const content = document.getElementById('psiModalContent');

            // Build scores HTML
            let scoresHtml = '<div class="psi-scores-grid">';
            if (data.scores) {
                const scoreItems = [
                    { name: 'Performance', value: data.scores.performance },
                    { name: 'Accessibility', value: data.scores.accessibility },
                    { name: 'Best Practices', value: data.scores.best_practices },
                    { name: 'SEO', value: data.scores.seo }
                ];
                scoreItems.forEach(item => {
                    if (item.value != null) {
                        const scoreClass = getScoreClass(item.value);
                        scoresHtml += `
                            <div class="psi-score-card">
                                <h4>${item.name}</h4>
                                <div class="psi-score-value ${scoreClass}">${Math.round(item.value)}</div>
                            </div>`;
                    }
                });
            }
            scoresHtml += '</div>';

            // Build metrics HTML
            let metricsHtml = '';
            if (data.metrics) {
                const m = data.metrics;
                metricsHtml = '<div class="psi-section"><h3>Core Web Vitals & Metrics</h3><div class="psi-metrics-grid">';
                const metrics = [
                    { label: 'First Contentful Paint', value: m.fcp, threshold: [1800, 3000] },
                    { label: 'Largest Contentful Paint', value: m.lcp, threshold: [2500, 4000] },
                    { label: 'Total Blocking Time', value: m.tbt, threshold: [200, 600], unit: 'ms' },
                    { label: 'Cumulative Layout Shift', value: m.cls, threshold: [0.1, 0.25], isCls: true },
                    { label: 'Speed Index', value: m.si, threshold: [3400, 5800] },
                    { label: 'Time to Interactive', value: m.tti, threshold: [3800, 7300] }
                ];
                metrics.forEach(metric => {
                    if (metric.value != null) {
                        let displayValue, colorClass;
                        if (metric.isCls) {
                            displayValue = metric.value.toFixed(3);
                            colorClass = metric.value <= metric.threshold[0] ? 'good' :
                                         metric.value <= metric.threshold[1] ? 'needs-improvement' : 'poor';
                        } else if (metric.unit === 'ms') {
                            displayValue = Math.round(metric.value) + 'ms';
                            colorClass = metric.value <= metric.threshold[0] ? 'good' :
                                         metric.value <= metric.threshold[1] ? 'needs-improvement' : 'poor';
                        } else {
                            displayValue = formatTime(metric.value);
                            colorClass = metric.value <= metric.threshold[0] ? 'good' :
                                         metric.value <= metric.threshold[1] ? 'needs-improvement' : 'poor';
                        }
                        metricsHtml += `
                            <div class="psi-metric">
                                <div class="label">${metric.label}</div>
                                <div class="value psi-score-value ${colorClass}">${displayValue}</div>
                            </div>`;
                    }
                });
                metricsHtml += '</div></div>';
            }

            // Build opportunities HTML
            let oppsHtml = '';
            if (data.opportunities && data.opportunities.length > 0) {
                oppsHtml = '<div class="psi-section"><h3>Optimization Opportunities</h3>';
                data.opportunities.forEach(opp => {
                    let savingsText = '';
                    if (opp.savings_ms > 0) {
                        savingsText += `~${(opp.savings_ms / 1000).toFixed(1)}s`;
                    }
                    if (opp.savings_bytes > 1024) {
                        savingsText += ` (${Math.round(opp.savings_bytes / 1024)} KB)`;
                    }
                    oppsHtml += `
                        <div class="psi-opportunity">
                            <div class="psi-opp-header">
                                <span class="psi-opp-title">${opp.title}</span>
                                <span class="psi-opp-savings">${savingsText}</span>
                            </div>
                            <div class="psi-opp-desc">${opp.description || ''}</div>
                        </div>`;
                });
                oppsHtml += '</div>';
            }

            // Build CrUX field data HTML
            let cruxHtml = '';
            if (data.crux_data && data.crux_data.overall_category) {
                const category = data.crux_data.overall_category;
                const badgeClass = category === 'FAST' ? 'good' : category === 'AVERAGE' ? 'needs-improvement' : 'poor';
                cruxHtml = `<div class="psi-section"><h3>Field Data (CrUX)</h3>
                    <p>Real-world performance from Chrome User Experience Report: <span class="psi-badge ${badgeClass}">${category}</span></p>
                </div>`;
            }

            // Build header
            const freshPsiUrl = 'https://pagespeed.web.dev/analysis?url=' + encodeURIComponent(data.url);

            content.innerHTML = `
                <div class="psi-modal-header">
                    <button class="psi-modal-close" onclick="closePsiModal()">&times;</button>
                    <h2>PageSpeed Insights Report</h2>
                    <div class="psi-url"><a href="${data.url}" target="_blank">${data.url}</a></div>
                    <div class="psi-meta">
                        Strategy: ${(data.strategy || 'mobile').toUpperCase()} |
                        Captured: ${data.fetch_time || 'Unknown'}
                    </div>
                </div>
                <div class="psi-modal-body">
                    ${scoresHtml}
                    ${metricsHtml}
                    ${cruxHtml}
                    ${oppsHtml}
                    <a href="${freshPsiUrl}" target="_blank" class="psi-fresh-link">Run Fresh Analysis on PageSpeed Insights &rarr;</a>
                </div>
            `;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePsiModal() {
            const modal = document.getElementById('psiModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('psiModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePsiModal();
                    }
                });
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePsiModal();
            }
        });
    </script>

    <!-- PSI Modal -->
    <div id="psiModal" class="psi-modal-overlay">
        <div class="psi-modal">
            <div id="psiModalContent"></div>
        </div>
    </div>

    <!-- NE Footer -->
    <footer style="background: var(--ne-header-bg); border-top: 3px solid var(--ne-gold); padding: 1.5rem; color: #fff; font-size: 0.875rem; margin-top: 40px;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <svg width="24" height="24" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100" height="100" fill="#967847"/>
                    <text x="50" y="62" font-family="Segoe UI, Arial" font-size="32" font-weight="bold" fill="white" text-anchor="middle">NE</text>
                </svg>
                <span>SEO Analysis Report for <strong>{{ domain }}</strong></span>
            </div>
            <div style="color: #999;">
                Generated {{ crawled_at }} ‚Ä¢ Powered by New Elevation
            </div>
        </div>
    </footer>
</body>
</html>
